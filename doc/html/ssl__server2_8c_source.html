<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>mbedtls: C:/dev2/luambedtls/dependencies/mbedtls/programs/ssl/ssl_server2.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">mbedtls
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('ssl__server2_8c_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ssl_server2.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *  SSL client with options</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *  Copyright (C) 2006-2015, ARM Limited, All Rights Reserved</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *  This file is part of mbed TLS (https://tls.mbed.org)</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *  This program is free software; you can redistribute it and/or modify</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> *  it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *  the Free Software Foundation; either version 2 of the License, or</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *  (at your option) any later version.</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *  This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> *  GNU General Public License for more details.</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> *  You should have received a copy of the GNU General Public License along</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> *  with this program; if not, write to the Free Software Foundation, Inc.,</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#if !defined(MBEDTLS_CONFIG_FILE)</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Compatibility names (set of defines) ">mbedtls/config.h</a>&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include MBEDTLS_CONFIG_FILE</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_PLATFORM_C)</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="platform_8h.html" title="mbed TLS Platform abstraction layer ">mbedtls/platform.h</a>&quot;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#define mbedtls_free       free</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define mbedtls_calloc    calloc</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define mbedtls_fprintf    fprintf</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define mbedtls_printf     printf</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#if !defined(MBEDTLS_ENTROPY_C) || \</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">    !defined(MBEDTLS_SSL_TLS_C) || !defined(MBEDTLS_SSL_SRV_C) || \</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">    !defined(MBEDTLS_NET_C) || !defined(MBEDTLS_CTR_DRBG_C)</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor"></span><span class="keywordtype">int</span> main( <span class="keywordtype">void</span> )</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;{</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    mbedtls_printf(<span class="stringliteral">&quot;MBEDTLS_ENTROPY_C and/or &quot;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;           <span class="stringliteral">&quot;MBEDTLS_SSL_TLS_C and/or MBEDTLS_SSL_SRV_C and/or &quot;</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;           <span class="stringliteral">&quot;MBEDTLS_NET_C and/or MBEDTLS_CTR_DRBG_C and/or not defined.\n&quot;</span>);</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keywordflow">return</span>( 0 );</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;}</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="net_8h.html" title="Network communication functions. ">mbedtls/net.h</a>&quot;</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="ssl_8h.html" title="SSL/TLS functions. ">mbedtls/ssl.h</a>&quot;</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="entropy_8h.html" title="Entropy accumulator implementation. ">mbedtls/entropy.h</a>&quot;</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="ctr__drbg_8h.html" title="CTR_DRBG based on AES-256 (NIST SP 800-90) ">mbedtls/ctr_drbg.h</a>&quot;</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="certs_8h.html" title="Sample certificates and DHM parameters for testing. ">mbedtls/certs.h</a>&quot;</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="x509_8h.html" title="X.509 generic defines and structures. ">mbedtls/x509.h</a>&quot;</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="error_8h.html" title="Error to string translation. ">mbedtls/error.h</a>&quot;</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="debug_8h.html" title="Debug functions. ">mbedtls/debug.h</a>&quot;</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="timing_8h.html" title="Portable interface to the CPU cycle counter. ">mbedtls/timing.h</a>&quot;</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="preprocessor">#if !defined(_WIN32)</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_CACHE_C)</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="ssl__cache_8h.html" title="SSL session cache implementation. ">mbedtls/ssl_cache.h</a>&quot;</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_TICKET_C)</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="ssl__ticket_8h.html" title="Internal functions shared by the SSL modules. ">mbedtls/ssl_ticket.h</a>&quot;</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_COOKIE_C)</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="ssl__cookie_8h.html" title="DTLS cookie callbacks implementation. ">mbedtls/ssl_cookie.h</a>&quot;</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_MEMORY_BUFFER_ALLOC_C)</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="memory__buffer__alloc_8h.html" title="Buffer-based memory allocator. ">mbedtls/memory_buffer_alloc.h</a>&quot;</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_SERVER_NAME_INDICATION) &amp;&amp; defined(MBEDTLS_FS_IO)</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define SNI_OPTION</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="preprocessor">#if defined(_WIN32)</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &lt;windows.h&gt;</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor">#define DFL_SERVER_ADDR         NULL</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_SERVER_PORT         &quot;4433&quot;</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_DEBUG_LEVEL         0</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_NBIO                0</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_READ_TIMEOUT        0</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_CA_FILE             &quot;&quot;</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_CA_PATH             &quot;&quot;</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_CRT_FILE            &quot;&quot;</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_KEY_FILE            &quot;&quot;</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_CRT_FILE2           &quot;&quot;</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_KEY_FILE2           &quot;&quot;</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_PSK                 &quot;&quot;</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_PSK_IDENTITY        &quot;Client_identity&quot;</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_PSK_LIST            NULL</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_FORCE_CIPHER        0</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_VERSION_SUITES      NULL</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_RENEGOTIATION       MBEDTLS_SSL_RENEGOTIATION_DISABLED</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_ALLOW_LEGACY        -2</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_RENEGOTIATE         0</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_RENEGO_DELAY        -2</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_RENEGO_PERIOD       -1</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_EXCHANGES           1</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_MIN_VERSION         -1</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_MAX_VERSION         -1</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_ARC4                -1</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_AUTH_MODE           -1</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_MFL_CODE            MBEDTLS_SSL_MAX_FRAG_LEN_NONE</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_TRUNC_HMAC          -1</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_TICKETS             MBEDTLS_SSL_SESSION_TICKETS_ENABLED</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_TICKET_TIMEOUT      86400</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_CACHE_MAX           -1</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_CACHE_TIMEOUT       -1</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_SNI                 NULL</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_ALPN_STRING         NULL</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_DHM_FILE            NULL</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_TRANSPORT           MBEDTLS_SSL_TRANSPORT_STREAM</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_COOKIES             1</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_ANTI_REPLAY         -1</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_HS_TO_MIN           0</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_HS_TO_MAX           0</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_BADMAC_LIMIT        -1</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_EXTENDED_MS         -1</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define DFL_ETM                 -1</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="preprocessor">#define LONG_RESPONSE &quot;&lt;p&gt;01-blah-blah-blah-blah-blah-blah-blah-blah-blah\r\n&quot; \</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="preprocessor">    &quot;02-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah\r\n&quot;  \</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="preprocessor">    &quot;03-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah\r\n&quot;  \</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="preprocessor">    &quot;04-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah\r\n&quot;  \</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="preprocessor">    &quot;05-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah\r\n&quot;  \</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="preprocessor">    &quot;06-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah\r\n&quot;  \</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="preprocessor">    &quot;07-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah-blah&lt;/p&gt;\r\n&quot;</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment">/* Uncomment LONG_RESPONSE at the end of HTTP_RESPONSE to test sending longer</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment"> * packets (for fragmentation purposes) */</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="preprocessor">#define HTTP_RESPONSE \</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="preprocessor">    &quot;HTTP/1.0 200 OK\r\nContent-Type: text/html\r\n\r\n&quot; \</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="preprocessor">    &quot;&lt;h2&gt;mbed TLS Test Server&lt;/h2&gt;\r\n&quot; \</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="preprocessor">    &quot;&lt;p&gt;Successful connection using: %s&lt;/p&gt;\r\n&quot; // LONG_RESPONSE</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment"> * Size of the basic I/O buffer. Able to hold our default response.</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment"> * You will need to adapt the mbedtls_ssl_get_bytes_avail() test in ssl-opt.sh</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment"> * if you change this value to something outside the range &lt;= 100 or &gt; 500</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="preprocessor">#define IO_BUF_LEN      200</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_X509_CRT_PARSE_C)</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_FS_IO)</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_IO \</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="preprocessor">    &quot;    ca_file=%%s          The single file containing the top-level CA(s) you fully trust\n&quot; \</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="preprocessor">    &quot;                        default: \&quot;\&quot; (pre-loaded)\n&quot; \</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="preprocessor">    &quot;    ca_path=%%s          The path containing the top-level CA(s) you fully trust\n&quot; \</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="preprocessor">    &quot;                        default: \&quot;\&quot; (pre-loaded) (overrides ca_file)\n&quot; \</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="preprocessor">    &quot;    crt_file=%%s         Your own cert and chain (in bottom to top order, top may be omitted)\n&quot; \</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="preprocessor">    &quot;                        default: see note after key_file2\n&quot; \</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="preprocessor">    &quot;    key_file=%%s         default: see note after key_file2\n&quot; \</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="preprocessor">    &quot;    crt_file2=%%s        Your second cert and chain (in bottom to top order, top may be omitted)\n&quot; \</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="preprocessor">    &quot;                        default: see note after key_file2\n&quot; \</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="preprocessor">    &quot;    key_file2=%%s        default: see note below\n&quot; \</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="preprocessor">    &quot;                        note: if neither crt_file/key_file nor crt_file2/key_file2 are used,\n&quot; \</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="preprocessor">    &quot;                              preloaded certificate(s) and key(s) are used if available\n&quot; \</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="preprocessor">    &quot;    dhm_file=%%s        File containing Diffie-Hellman parameters\n&quot; \</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="preprocessor">    &quot;                       default: preloaded parameters\n&quot;</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_IO \</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="preprocessor">    &quot;\n&quot;                                                    \</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="preprocessor">    &quot;    No file operations available (MBEDTLS_FS_IO not defined)\n&quot; \</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="preprocessor">    &quot;\n&quot;</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_FS_IO */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_IO &quot;&quot;</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_X509_CRT_PARSE_C */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_KEY_EXCHANGE__SOME__PSK_ENABLED)</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_PSK                                                   \</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="preprocessor">    &quot;    psk=%%s              default: \&quot;\&quot; (in hex, without 0x)\n&quot; \</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="preprocessor">    &quot;    psk_identity=%%s     default: \&quot;Client_identity\&quot;\n&quot;</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_PSK &quot;&quot;</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_KEY_EXCHANGE__SOME__PSK_ENABLED */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_SESSION_TICKETS)</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_TICKETS                                       \</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="preprocessor">    &quot;    tickets=%%d          default: 1 (enabled)\n&quot;       \</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="preprocessor">    &quot;    ticket_timeout=%%d   default: 86400 (one day)\n&quot;</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_TICKETS &quot;&quot;</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_SSL_SESSION_TICKETS */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_CACHE_C)</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_CACHE                                             \</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="preprocessor">    &quot;    cache_max=%%d        default: cache default (50)\n&quot;    \</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="preprocessor">    &quot;    cache_timeout=%%d    default: cache default (1d)\n&quot;</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_CACHE &quot;&quot;</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_SSL_CACHE_C */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="preprocessor">#if defined(SNI_OPTION)</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_SNI                                                           \</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="preprocessor">    &quot;    sni=%%s              name1,cert1,key1,ca1,crl1,auth1[,...]\n&quot;  \</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="preprocessor">    &quot;                        default: disabled\n&quot;</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_SNI &quot;&quot;</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* SNI_OPTION */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_MAX_FRAGMENT_LENGTH)</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_MAX_FRAG_LEN                                      \</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="preprocessor">    &quot;    max_frag_len=%%d     default: 16384 (tls default)\n&quot;   \</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="preprocessor">    &quot;                        options: 512, 1024, 2048, 4096\n&quot;</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_MAX_FRAG_LEN &quot;&quot;</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_SSL_MAX_FRAGMENT_LENGTH */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_TRUNCATED_HMAC)</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_TRUNC_HMAC \</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="preprocessor">    &quot;    trunc_hmac=%%d       default: library default\n&quot;</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_TRUNC_HMAC &quot;&quot;</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_ALPN)</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_ALPN \</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="preprocessor">    &quot;    alpn=%%s             default: \&quot;\&quot; (disabled)\n&quot;   \</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="preprocessor">    &quot;                        example: spdy/1,http/1.1\n&quot;</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_ALPN &quot;&quot;</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_SSL_ALPN */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_DTLS_HELLO_VERIFY)</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_COOKIES \</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="preprocessor">    &quot;    cookies=0/1/-1      default: 1 (enabled)\n&quot;        \</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="preprocessor">    &quot;                        0: disabled, -1: library default (broken)\n&quot;</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_COOKIES &quot;&quot;</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_DTLS_ANTI_REPLAY)</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_ANTI_REPLAY \</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="preprocessor">    &quot;    anti_replay=0/1     default: (library default: enabled)\n&quot;</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_ANTI_REPLAY &quot;&quot;</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_DTLS_BADMAC_LIMIT)</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_BADMAC_LIMIT \</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="preprocessor">    &quot;    badmac_limit=%%d     default: (library default: disabled)\n&quot;</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_BADMAC_LIMIT &quot;&quot;</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_PROTO_DTLS)</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_DTLS \</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="preprocessor">    &quot;    dtls=%%d             default: 0 (TLS)\n&quot;                           \</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="preprocessor">    &quot;    hs_timeout=%%d-%%d    default: (library default: 1000-60000)\n&quot;    \</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="preprocessor">    &quot;                        range of DTLS handshake timeouts in millisecs\n&quot;</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_DTLS &quot;&quot;</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_EXTENDED_MASTER_SECRET)</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_EMS \</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="preprocessor">    &quot;    extended_ms=0/1     default: (library default: on)\n&quot;</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_EMS &quot;&quot;</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_ENCRYPT_THEN_MAC)</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_ETM \</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="preprocessor">    &quot;    etm=0/1             default: (library default: on)\n&quot;</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_ETM &quot;&quot;</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_RENEGOTIATION)</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_RENEGO \</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="preprocessor">    &quot;    renegotiation=%%d    default: 0 (disabled)\n&quot;      \</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="preprocessor">    &quot;    renegotiate=%%d      default: 0 (disabled)\n&quot;      \</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="preprocessor">    &quot;    renego_delay=%%d     default: -2 (library default)\n&quot; \</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="preprocessor">    &quot;    renego_period=%%d    default: (library default)\n&quot;</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define USAGE_RENEGO &quot;&quot;</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="preprocessor">#define USAGE \</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="preprocessor">    &quot;\n usage: ssl_server2 param=&lt;&gt;...\n&quot;                   \</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="preprocessor">    &quot;\n acceptable parameters:\n&quot;                           \</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="preprocessor">    &quot;    server_addr=%%d      default: (all interfaces)\n&quot;  \</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="preprocessor">    &quot;    server_port=%%d      default: 4433\n&quot;              \</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="preprocessor">    &quot;    debug_level=%%d      default: 0 (disabled)\n&quot;      \</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="preprocessor">    &quot;    nbio=%%d             default: 0 (blocking I/O)\n&quot;  \</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="preprocessor">    &quot;                        options: 1 (non-blocking), 2 (added delays)\n&quot; \</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="preprocessor">    &quot;    read_timeout=%%d     default: 0 (no timeout)\n&quot;    \</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="preprocessor">    &quot;\n&quot;                                                    \</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="preprocessor">    USAGE_DTLS                                              \</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="preprocessor">    USAGE_COOKIES                                           \</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="preprocessor">    USAGE_ANTI_REPLAY                                       \</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="preprocessor">    USAGE_BADMAC_LIMIT                                      \</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="preprocessor">    &quot;\n&quot;                                                    \</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="preprocessor">    &quot;    auth_mode=%%s        default: (library default: none)\n&quot;      \</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="preprocessor">    &quot;                        options: none, optional, required\n&quot; \</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="preprocessor">    USAGE_IO                                                \</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="preprocessor">    USAGE_SNI                                               \</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="preprocessor">    &quot;\n&quot;                                                    \</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="preprocessor">    USAGE_PSK                                               \</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="preprocessor">    &quot;\n&quot;                                                    \</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="preprocessor">    &quot;    allow_legacy=%%d     default: (library default: no)\n&quot;      \</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="preprocessor">    USAGE_RENEGO                                            \</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="preprocessor">    &quot;    exchanges=%%d        default: 1\n&quot;                 \</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="preprocessor">    &quot;\n&quot;                                                    \</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="preprocessor">    USAGE_TICKETS                                           \</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="preprocessor">    USAGE_CACHE                                             \</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="preprocessor">    USAGE_MAX_FRAG_LEN                                      \</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="preprocessor">    USAGE_TRUNC_HMAC                                        \</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="preprocessor">    USAGE_ALPN                                              \</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="preprocessor">    USAGE_EMS                                               \</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="preprocessor">    USAGE_ETM                                               \</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="preprocessor">    &quot;\n&quot;                                                    \</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="preprocessor">    &quot;    arc4=%%d             default: (library default: 0)\n&quot; \</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="preprocessor">    &quot;    min_version=%%s      default: (library default: tls1)\n&quot;       \</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="preprocessor">    &quot;    max_version=%%s      default: (library default: tls1_2)\n&quot;     \</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="preprocessor">    &quot;    force_version=%%s    default: \&quot;\&quot; (none)\n&quot;       \</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="preprocessor">    &quot;                        options: ssl3, tls1, tls1_1, tls1_2, dtls1, dtls1_2\n&quot; \</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="preprocessor">    &quot;\n&quot;                                                                \</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="preprocessor">    &quot;    version_suites=a,b,c,d      per-version ciphersuites\n&quot;        \</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="preprocessor">    &quot;                                in order from ssl3 to tls1_2\n&quot;    \</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="preprocessor">    &quot;                                default: all enabled\n&quot;            \</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="preprocessor">    &quot;    force_ciphersuite=&lt;name&gt;    default: all enabled\n&quot;            \</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="preprocessor">    &quot; acceptable ciphersuite names:\n&quot;</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment"> * global options</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="keyword">struct </span>options</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;{</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *server_addr;    <span class="comment">/* address on which the ssl service runs    */</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *server_port;    <span class="comment">/* port on which the ssl service runs       */</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="keywordtype">int</span> debug_level;            <span class="comment">/* level of debugging                       */</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <span class="keywordtype">int</span> nbio;                   <span class="comment">/* should I/O be blocking?                  */</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    uint32_t read_timeout;      <span class="comment">/* timeout on mbedtls_ssl_read() in milliseconds    */</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *ca_file;        <span class="comment">/* the file with the CA certificate(s)      */</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *ca_path;        <span class="comment">/* the path with the CA certificate(s) reside */</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *crt_file;       <span class="comment">/* the file with the server certificate     */</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *key_file;       <span class="comment">/* the file with the server key             */</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *crt_file2;      <span class="comment">/* the file with the 2nd server certificate */</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *key_file2;      <span class="comment">/* the file with the 2nd server key         */</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *psk;            <span class="comment">/* the pre-shared key                       */</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *psk_identity;   <span class="comment">/* the pre-shared key identity              */</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    <span class="keywordtype">char</span> *psk_list;             <span class="comment">/* list of PSK id/key pairs for callback    */</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="keywordtype">int</span> force_ciphersuite[2];   <span class="comment">/* protocol/ciphersuite to use, or all      */</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *version_suites; <span class="comment">/* per-version ciphersuites                 */</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    <span class="keywordtype">int</span> renegotiation;          <span class="comment">/* enable / disable renegotiation           */</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="keywordtype">int</span> allow_legacy;           <span class="comment">/* allow legacy renegotiation               */</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <span class="keywordtype">int</span> renegotiate;            <span class="comment">/* attempt renegotiation?                   */</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="keywordtype">int</span> renego_delay;           <span class="comment">/* delay before enforcing renegotiation     */</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keywordtype">int</span> renego_period;          <span class="comment">/* period for automatic renegotiation       */</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="keywordtype">int</span> exchanges;              <span class="comment">/* number of data exchanges                 */</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="keywordtype">int</span> min_version;            <span class="comment">/* minimum protocol version accepted        */</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="keywordtype">int</span> max_version;            <span class="comment">/* maximum protocol version accepted        */</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    <span class="keywordtype">int</span> arc4;                   <span class="comment">/* flag for arc4 suites support             */</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    <span class="keywordtype">int</span> auth_mode;              <span class="comment">/* verify mode for connection               */</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> mfl_code;     <span class="comment">/* code for maximum fragment length         */</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="keywordtype">int</span> trunc_hmac;             <span class="comment">/* accept truncated hmac?                   */</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="keywordtype">int</span> tickets;                <span class="comment">/* enable / disable session tickets         */</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordtype">int</span> ticket_timeout;         <span class="comment">/* session ticket lifetime                  */</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <span class="keywordtype">int</span> cache_max;              <span class="comment">/* max number of session cache entries      */</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="keywordtype">int</span> cache_timeout;          <span class="comment">/* expiration delay of session cache entries */</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    <span class="keywordtype">char</span> *sni;                  <span class="comment">/* string describing sni information        */</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *alpn_string;    <span class="comment">/* ALPN supported protocols                 */</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *dhm_file;       <span class="comment">/* the file with the DH parameters          */</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="keywordtype">int</span> extended_ms;            <span class="comment">/* allow negotiation of extended MS?        */</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    <span class="keywordtype">int</span> etm;                    <span class="comment">/* allow negotiation of encrypt-then-MAC?   */</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="keywordtype">int</span> transport;              <span class="comment">/* TLS or DTLS?                             */</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    <span class="keywordtype">int</span> cookies;                <span class="comment">/* Use cookies for DTLS? -1 to break them   */</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordtype">int</span> anti_replay;            <span class="comment">/* Use anti-replay for DTLS? -1 for default */</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    uint32_t hs_to_min;         <span class="comment">/* Initial value of DTLS handshake timer    */</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    uint32_t hs_to_max;         <span class="comment">/* Max value of DTLS handshake timer        */</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="keywordtype">int</span> badmac_limit;           <span class="comment">/* Limit of records with bad MAC            */</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;} opt;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> my_debug( <span class="keywordtype">void</span> *ctx, <span class="keywordtype">int</span> level,</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                      <span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> line,</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                      <span class="keyword">const</span> <span class="keywordtype">char</span> *str )</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;{</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *basename;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <span class="comment">/* Extract basename from file */</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="keywordflow">for</span>( p = basename = file; *p != <span class="charliteral">&#39;\0&#39;</span>; p++ )</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        <span class="keywordflow">if</span>( *p == <span class="charliteral">&#39;/&#39;</span> || *p == <span class="charliteral">&#39;\\&#39;</span> )</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;            basename = p + 1;</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    mbedtls_fprintf( (FILE *) ctx, <span class="stringliteral">&quot;%s:%04d: |%d| %s&quot;</span>, basename, line, level, str );</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    fflush(  (FILE *) ctx  );</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;}</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="comment"> * Test recv/send functions that make sure each try returns</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="comment"> * WANT_READ/WANT_WRITE at least once before sucesseding</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> my_recv( <span class="keywordtype">void</span> *ctx, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> len )</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;{</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span> first_try = 1;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="keywordtype">int</span> ret;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <span class="keywordflow">if</span>( first_try )</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    {</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        first_try = 0;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        <span class="keywordflow">return</span>( <a class="code" href="ssl_8h.html#a67a1e093cf042831aa60bb567915b560">MBEDTLS_ERR_SSL_WANT_READ</a> );</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    }</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    ret = <a class="code" href="net_8h.html#a03af351ec420bbeb5e91357abcfb3663" title="Read at most &#39;len&#39; characters. If no error occurs, the actual amount read is returned. ">mbedtls_net_recv</a>( ctx, buf, len );</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    <span class="keywordflow">if</span>( ret != <a class="code" href="ssl_8h.html#a67a1e093cf042831aa60bb567915b560">MBEDTLS_ERR_SSL_WANT_READ</a> )</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        first_try = 1; <span class="comment">/* Next call will be a new operation */</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <span class="keywordflow">return</span>( ret );</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;}</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> my_send( <span class="keywordtype">void</span> *ctx, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> len )</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;{</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span> first_try = 1;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="keywordtype">int</span> ret;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="keywordflow">if</span>( first_try )</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    {</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        first_try = 0;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        <span class="keywordflow">return</span>( <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a> );</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    }</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    ret = <a class="code" href="net_8h.html#a4841afd0e14f1fd44b82c3a850961ab7" title="Write at most &#39;len&#39; characters. If no error occurs, the actual amount read is returned. ">mbedtls_net_send</a>( ctx, buf, len );</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="keywordflow">if</span>( ret != <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a> )</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        first_try = 1; <span class="comment">/* Next call will be a new operation */</span></div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="keywordflow">return</span>( ret );</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;}</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="comment"> * Return authmode from string, or -1 on error</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> get_auth_mode( <span class="keyword">const</span> <span class="keywordtype">char</span> *s )</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;{</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    <span class="keywordflow">if</span>( strcmp( s, <span class="stringliteral">&quot;none&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        <span class="keywordflow">return</span>( MBEDTLS_SSL_VERIFY_NONE );</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <span class="keywordflow">if</span>( strcmp( s, <span class="stringliteral">&quot;optional&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        <span class="keywordflow">return</span>( MBEDTLS_SSL_VERIFY_OPTIONAL );</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <span class="keywordflow">if</span>( strcmp( s, <span class="stringliteral">&quot;required&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        <span class="keywordflow">return</span>( MBEDTLS_SSL_VERIFY_REQUIRED );</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    <span class="keywordflow">return</span>( -1 );</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;}</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="comment"> * Used by sni_parse and psk_parse to handle coma-separated lists</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="preprocessor">#define GET_ITEM( dst )         \</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="preprocessor">    dst = p;                    \</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="preprocessor">    while( *p != &#39;,&#39; )          \</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="preprocessor">        if( ++p &gt; end )         \</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="preprocessor">            goto error;         \</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="preprocessor">    *p++ = &#39;\0&#39;;</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="preprocessor">#if defined(SNI_OPTION)</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>_sni_entry sni_entry;</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="keyword">struct </span>_sni_entry {</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *name;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <a class="code" href="structmbedtls__x509__crt.html">mbedtls_x509_crt</a> *cert;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <a class="code" href="structmbedtls__pk__context.html" title="Public key container. ">mbedtls_pk_context</a> *key;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <a class="code" href="structmbedtls__x509__crt.html">mbedtls_x509_crt</a>* ca;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <a class="code" href="structmbedtls__x509__crl.html">mbedtls_x509_crl</a>* crl;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="keywordtype">int</span> authmode;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    sni_entry *next;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;};</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="keywordtype">void</span> sni_free( sni_entry *head )</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;{</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    sni_entry *cur = head, *next;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    <span class="keywordflow">while</span>( cur != NULL )</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    {</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        <a class="code" href="group__x509__module.html#gab33c1e4e20bea7ce536119f54a113c6b" title="Unallocate all certificate data. ">mbedtls_x509_crt_free</a>( cur-&gt;cert );</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;        mbedtls_free( cur-&gt;cert );</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        <a class="code" href="pk_8h.html#ac6a9786d96abfd73c4dff6814238feb9" title="Free a mbedtls_pk_context. ">mbedtls_pk_free</a>( cur-&gt;key );</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        mbedtls_free( cur-&gt;key );</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        <a class="code" href="group__x509__module.html#gab33c1e4e20bea7ce536119f54a113c6b" title="Unallocate all certificate data. ">mbedtls_x509_crt_free</a>( cur-&gt;ca );</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        mbedtls_free( cur-&gt;ca );</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;        <a class="code" href="group__x509__module.html#gaeb19c3326889f9e493fbd605c1113b96" title="Unallocate all CRL data. ">mbedtls_x509_crl_free</a>( cur-&gt;crl );</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        mbedtls_free( cur-&gt;crl );</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        next = cur-&gt;next;</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        mbedtls_free( cur );</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        cur = next;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    }</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;}</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="comment"> * Parse a string of sextuples name1,crt1,key1,ca1,crl1,auth1[,...]</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment"> * into a usable sni_entry list. For ca1, crl1, auth1, the special value</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="comment"> * &#39;-&#39; means unset. If ca1 is unset, then crl1 is ignored too.</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment"> * Modifies the input string! This is not production quality!</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;sni_entry *sni_parse( <span class="keywordtype">char</span> *sni_string )</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;{</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    sni_entry *cur = NULL, *<span class="keyword">new</span> = NULL;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    <span class="keywordtype">char</span> *p = sni_string;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    <span class="keywordtype">char</span> *end = p;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    <span class="keywordtype">char</span> *crt_file, *key_file, *ca_file, *crl_file, *auth_str;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <span class="keywordflow">while</span>( *end != <span class="charliteral">&#39;\0&#39;</span> )</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        ++end;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    *end = <span class="charliteral">&#39;,&#39;</span>;</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    <span class="keywordflow">while</span>( p &lt;= end )</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    {</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        <span class="keywordflow">if</span>( ( <span class="keyword">new</span> = mbedtls_calloc( 1, <span class="keyword">sizeof</span>( sni_entry ) ) ) == NULL )</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        {</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;            sni_free( cur );</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;            <span class="keywordflow">return</span>( NULL );</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        }</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        GET_ITEM( new-&gt;name );</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        GET_ITEM( crt_file );</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        GET_ITEM( key_file );</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        GET_ITEM( ca_file );</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        GET_ITEM( crl_file );</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        GET_ITEM( auth_str );</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <span class="keywordflow">if</span>( ( new-&gt;cert = mbedtls_calloc( 1, <span class="keyword">sizeof</span>( <a class="code" href="structmbedtls__x509__crt.html">mbedtls_x509_crt</a> ) ) ) == NULL ||</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;            ( new-&gt;key = mbedtls_calloc( 1, <span class="keyword">sizeof</span>( <a class="code" href="structmbedtls__pk__context.html" title="Public key container. ">mbedtls_pk_context</a> ) ) ) == NULL )</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            <span class="keywordflow">goto</span> error;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        <a class="code" href="group__x509__module.html#ga016dd06bc770e77b84005f305df20ed1" title="Initialize a certificate (chain) ">mbedtls_x509_crt_init</a>( new-&gt;cert );</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        <a class="code" href="pk_8h.html#a999d1160bb30c03d0c4382c3a9b0aa89" title="Initialize a mbedtls_pk_context (as NONE) ">mbedtls_pk_init</a>( new-&gt;key );</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        <span class="keywordflow">if</span>( <a class="code" href="group__x509__module.html#gad4da63133d3590aa311488497d4c38ec" title="Load one or more certificates and add them to the chained list. Parses permissively. If some certificates can be parsed, the result is the number of failed certificates it encountered. If none complete correctly, the first error is returned. ">mbedtls_x509_crt_parse_file</a>( new-&gt;cert, crt_file ) != 0 ||</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;            <a class="code" href="pk_8h.html#a935d710e542409462d0209f2381da83e" title="Load and parse a private key. ">mbedtls_pk_parse_keyfile</a>( new-&gt;key, key_file, <span class="stringliteral">&quot;&quot;</span> ) != 0 )</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;            <span class="keywordflow">goto</span> error;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        <span class="keywordflow">if</span>( strcmp( ca_file, <span class="stringliteral">&quot;-&quot;</span> ) != 0 )</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        {</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;            <span class="keywordflow">if</span>( ( new-&gt;ca = mbedtls_calloc( 1, <span class="keyword">sizeof</span>( <a class="code" href="structmbedtls__x509__crt.html">mbedtls_x509_crt</a> ) ) ) == NULL )</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                <span class="keywordflow">goto</span> error;</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;            <a class="code" href="group__x509__module.html#ga016dd06bc770e77b84005f305df20ed1" title="Initialize a certificate (chain) ">mbedtls_x509_crt_init</a>( new-&gt;ca );</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            <span class="keywordflow">if</span>( <a class="code" href="group__x509__module.html#gad4da63133d3590aa311488497d4c38ec" title="Load one or more certificates and add them to the chained list. Parses permissively. If some certificates can be parsed, the result is the number of failed certificates it encountered. If none complete correctly, the first error is returned. ">mbedtls_x509_crt_parse_file</a>( new-&gt;ca, ca_file ) != 0 )</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                <span class="keywordflow">goto</span> error;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        }</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        <span class="keywordflow">if</span>( strcmp( crl_file, <span class="stringliteral">&quot;-&quot;</span> ) != 0 )</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;        {</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;            <span class="keywordflow">if</span>( ( new-&gt;crl = mbedtls_calloc( 1, <span class="keyword">sizeof</span>( <a class="code" href="structmbedtls__x509__crl.html">mbedtls_x509_crl</a> ) ) ) == NULL )</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                <span class="keywordflow">goto</span> error;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;            <a class="code" href="group__x509__module.html#ga8513a192e281217802837571da98e218" title="Initialize a CRL (chain) ">mbedtls_x509_crl_init</a>( new-&gt;crl );</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;            <span class="keywordflow">if</span>( <a class="code" href="group__x509__module.html#ga8e096827f1240b8f8bc15d6a83593f22" title="Load one or more CRLs and append them to the chained list. ">mbedtls_x509_crl_parse_file</a>( new-&gt;crl, crl_file ) != 0 )</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                <span class="keywordflow">goto</span> error;</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        }</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        <span class="keywordflow">if</span>( strcmp( auth_str, <span class="stringliteral">&quot;-&quot;</span> ) != 0 )</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        {</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;            <span class="keywordflow">if</span>( ( new-&gt;authmode = get_auth_mode( auth_str ) ) &lt; 0 )</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                <span class="keywordflow">goto</span> error;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        }</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;            <span class="keyword">new</span>-&gt;authmode = DFL_AUTH_MODE;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        <span class="keyword">new</span>-&gt;next = cur;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        cur = <span class="keyword">new</span>;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    }</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <span class="keywordflow">return</span>( cur );</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;error:</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    sni_free( <span class="keyword">new</span> );</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    sni_free( cur );</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    <span class="keywordflow">return</span>( NULL );</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;}</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="comment"> * SNI callback.</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="keywordtype">int</span> sni_callback( <span class="keywordtype">void</span> *p_info, <a class="code" href="structmbedtls__ssl__context.html">mbedtls_ssl_context</a> *ssl,</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">size_t</span> name_len )</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;{</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <span class="keyword">const</span> sni_entry *cur = (<span class="keyword">const</span> sni_entry *) p_info;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="keywordflow">while</span>( cur != NULL )</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    {</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <span class="keywordflow">if</span>( name_len == strlen( cur-&gt;name ) &amp;&amp;</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;            memcmp( name, cur-&gt;name, name_len ) == 0 )</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        {</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;            <span class="keywordflow">if</span>( cur-&gt;ca != NULL )</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                <a class="code" href="ssl_8h.html#a33a781dcdc16bd649ea0346a598e9656" title="Set the data required to verify peer certificate for the current handshake. ">mbedtls_ssl_set_hs_ca_chain</a>( ssl, cur-&gt;ca, cur-&gt;crl );</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;            <span class="keywordflow">if</span>( cur-&gt;authmode != DFL_AUTH_MODE )</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                <a class="code" href="ssl_8h.html#a8366b49e25054078b5be139c0ce560d7" title="Set authmode for the current handshake. ">mbedtls_ssl_set_hs_authmode</a>( ssl, cur-&gt;authmode );</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            <span class="keywordflow">return</span>( <a class="code" href="ssl_8h.html#aa0353666974b1cd19dafb2c2b165d2f2" title="Set own certificate and key for the current handshake. ">mbedtls_ssl_set_hs_own_cert</a>( ssl, cur-&gt;cert, cur-&gt;key ) );</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;        }</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        cur = cur-&gt;next;</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    }</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    <span class="keywordflow">return</span>( -1 );</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;}</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* SNI_OPTION */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_KEY_EXCHANGE__SOME__PSK_ENABLED)</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="preprocessor">#define HEX2NUM( c )                    \</span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="preprocessor">        if( c &gt;= &#39;0&#39; &amp;&amp; c &lt;= &#39;9&#39; )      \</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="preprocessor">            c -= &#39;0&#39;;                   \</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;<span class="preprocessor">        else if( c &gt;= &#39;a&#39; &amp;&amp; c &lt;= &#39;f&#39; ) \</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;<span class="preprocessor">            c -= &#39;a&#39; - 10;              \</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;<span class="preprocessor">        else if( c &gt;= &#39;A&#39; &amp;&amp; c &lt;= &#39;F&#39; ) \</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;<span class="preprocessor">            c -= &#39;A&#39; - 10;              \</span></div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;<span class="preprocessor">        else                            \</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="preprocessor">            return( -1 );</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="comment"> * Convert a hex string to bytes.</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="comment"> * Return 0 on success, -1 on error.</span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="keywordtype">int</span> unhexify( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *output, <span class="keyword">const</span> <span class="keywordtype">char</span> *input, <span class="keywordtype">size_t</span> *olen )</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;{</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="keywordtype">size_t</span> j;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    *olen = strlen( input );</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    <span class="keywordflow">if</span>( *olen % 2 != 0 || *olen / 2 &gt; MBEDTLS_PSK_MAX_LEN )</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;        <span class="keywordflow">return</span>( -1 );</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;    *olen /= 2;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    <span class="keywordflow">for</span>( j = 0; j &lt; *olen * 2; j += 2 )</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    {</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        c = input[j];</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        HEX2NUM( c );</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        output[ j / 2 ] = c &lt;&lt; 4;</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        c = input[j + 1];</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        HEX2NUM( c );</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        output[ j / 2 ] |= c;</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    }</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    <span class="keywordflow">return</span>( 0 );</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;}</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>_psk_entry psk_entry;</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="keyword">struct </span>_psk_entry</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;{</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *name;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    <span class="keywordtype">size_t</span> key_len;</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[MBEDTLS_PSK_MAX_LEN];</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    psk_entry *next;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;};</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="comment"> * Free a list of psk_entry&#39;s</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="keywordtype">void</span> psk_free( psk_entry *head )</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;{</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    psk_entry *next;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    <span class="keywordflow">while</span>( head != NULL )</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    {</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        next = head-&gt;next;</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        mbedtls_free( head );</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        head = next;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    }</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;}</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="comment"> * Parse a string of pairs name1,key1[,name2,key2[,...]]</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="comment"> * into a usable psk_entry list.</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="comment"> * Modifies the input string! This is not production quality!</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;psk_entry *psk_parse( <span class="keywordtype">char</span> *psk_string )</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;{</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    psk_entry *cur = NULL, *<span class="keyword">new</span> = NULL;</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    <span class="keywordtype">char</span> *p = psk_string;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    <span class="keywordtype">char</span> *end = p;</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    <span class="keywordtype">char</span> *key_hex;</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="keywordflow">while</span>( *end != <span class="charliteral">&#39;\0&#39;</span> )</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        ++end;</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    *end = <span class="charliteral">&#39;,&#39;</span>;</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    <span class="keywordflow">while</span>( p &lt;= end )</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    {</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;        <span class="keywordflow">if</span>( ( <span class="keyword">new</span> = mbedtls_calloc( 1, <span class="keyword">sizeof</span>( psk_entry ) ) ) == NULL )</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;            <span class="keywordflow">goto</span> error;</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        memset( <span class="keyword">new</span>, 0, <span class="keyword">sizeof</span>( psk_entry ) );</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        GET_ITEM( new-&gt;name );</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        GET_ITEM( key_hex );</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        <span class="keywordflow">if</span>( unhexify( new-&gt;key, key_hex, &amp;new-&gt;key_len ) != 0 )</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;            <span class="keywordflow">goto</span> error;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;        <span class="keyword">new</span>-&gt;next = cur;</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        cur = <span class="keyword">new</span>;</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    }</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <span class="keywordflow">return</span>( cur );</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;error:</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    psk_free( <span class="keyword">new</span> );</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    psk_free( cur );</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordflow">return</span>( 0 );</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;}</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="comment"> * PSK callback</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;<span class="keywordtype">int</span> psk_callback( <span class="keywordtype">void</span> *p_info, <a class="code" href="structmbedtls__ssl__context.html">mbedtls_ssl_context</a> *ssl,</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">size_t</span> name_len )</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;{</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;    psk_entry *cur = (psk_entry *) p_info;</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    <span class="keywordflow">while</span>( cur != NULL )</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    {</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;        <span class="keywordflow">if</span>( name_len == strlen( cur-&gt;name ) &amp;&amp;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;            memcmp( name, cur-&gt;name, name_len ) == 0 )</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        {</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;            <span class="keywordflow">return</span>( <a class="code" href="ssl_8h.html#a50f8bb06a3ec75f6fec4ccc2c1aad151" title="Set the Pre Shared Key (PSK) for the current handshake. ">mbedtls_ssl_set_hs_psk</a>( ssl, cur-&gt;key, cur-&gt;key_len ) );</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;        }</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        cur = cur-&gt;next;</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    }</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    <span class="keywordflow">return</span>( -1 );</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;}</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_KEY_EXCHANGE__SOME__PSK_ENABLED */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="keyword">static</span> <a class="code" href="structmbedtls__net__context.html">mbedtls_net_context</a> listen_fd, client_fd;</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="comment">/* Interruption handler to ensure clean exit (for valgrind testing) */</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="preprocessor">#if !defined(_WIN32)</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> received_sigterm = 0;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;<span class="keywordtype">void</span> term_handler( <span class="keywordtype">int</span> sig )</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;{</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    ((void) sig);</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    received_sigterm = 1;</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    <a class="code" href="net_8h.html#a77c35cb3f4b9fe6035d1d3742f3b4a24" title="Gracefully shutdown the connection and free associated data. ">mbedtls_net_free</a>( &amp;listen_fd ); <span class="comment">/* causes mbedtls_net_accept() to abort */</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <a class="code" href="net_8h.html#a77c35cb3f4b9fe6035d1d3742f3b4a24" title="Gracefully shutdown the connection and free associated data. ">mbedtls_net_free</a>( &amp;client_fd ); <span class="comment">/* causes net_read() to abort */</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;}</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;<span class="keywordtype">int</span> main( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[] )</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;{</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    <span class="keywordtype">int</span> ret = 0, len, written, frags, exchanges_left;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <span class="keywordtype">int</span> version_suites[4][2];</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[IO_BUF_LEN];</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_KEY_EXCHANGE__SOME__PSK_ENABLED)</span></div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;<span class="preprocessor"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> psk[MBEDTLS_PSK_MAX_LEN];</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    <span class="keywordtype">size_t</span> psk_len = 0;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    psk_entry *psk_info = NULL;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;<span class="preprocessor"></span>    <span class="keyword">const</span> <span class="keywordtype">char</span> *pers = <span class="stringliteral">&quot;ssl_server2&quot;</span>;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> client_ip[16] = { 0 };</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    <span class="keywordtype">size_t</span> cliip_len;</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_COOKIE_C)</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;<span class="preprocessor"></span>    <a class="code" href="structmbedtls__ssl__cookie__ctx.html" title="Context for the default cookie functions. ">mbedtls_ssl_cookie_ctx</a> cookie_ctx;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <a class="code" href="structmbedtls__entropy__context.html" title="Entropy context structure. ">mbedtls_entropy_context</a> entropy;</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    <a class="code" href="structmbedtls__ctr__drbg__context.html" title="CTR_DRBG context structure. ">mbedtls_ctr_drbg_context</a> ctr_drbg;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    <a class="code" href="structmbedtls__ssl__context.html">mbedtls_ssl_context</a> ssl;</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <a class="code" href="structmbedtls__ssl__config.html">mbedtls_ssl_config</a> conf;</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_TIMING_C)</span></div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;<span class="preprocessor"></span>    <a class="code" href="structmbedtls__timing__delay__context.html" title="Context for mbedtls_timing_set/get_delay() ">mbedtls_timing_delay_context</a> timer;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_SSL_RENEGOTIATION)</span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="preprocessor"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> renego_period[8] = { 0 };</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_X509_CRT_PARSE_C)</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;<span class="preprocessor"></span>    uint32_t flags;</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <a class="code" href="structmbedtls__x509__crt.html">mbedtls_x509_crt</a> cacert;</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    <a class="code" href="structmbedtls__x509__crt.html">mbedtls_x509_crt</a> srvcert;</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    <a class="code" href="structmbedtls__pk__context.html" title="Public key container. ">mbedtls_pk_context</a> pkey;</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <a class="code" href="structmbedtls__x509__crt.html">mbedtls_x509_crt</a> srvcert2;</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    <a class="code" href="structmbedtls__pk__context.html" title="Public key container. ">mbedtls_pk_context</a> pkey2;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordtype">int</span> key_cert_init = 0, key_cert_init2 = 0;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_DHM_C) &amp;&amp; defined(MBEDTLS_FS_IO)</span></div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;<span class="preprocessor"></span>    <a class="code" href="structmbedtls__dhm__context.html" title="DHM context structure. ">mbedtls_dhm_context</a> dhm;</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_SSL_CACHE_C)</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;<span class="preprocessor"></span>    <a class="code" href="structmbedtls__ssl__cache__context.html" title="Cache context. ">mbedtls_ssl_cache_context</a> cache;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_SSL_SESSION_TICKETS)</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="preprocessor"></span>    <a class="code" href="structmbedtls__ssl__ticket__context.html" title="Context for session ticket handling functions. ">mbedtls_ssl_ticket_context</a> ticket_ctx;</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(SNI_OPTION)</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;<span class="preprocessor"></span>    sni_entry *sni_info = NULL;</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_SSL_ALPN)</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="preprocessor"></span>    <span class="keyword">const</span> <span class="keywordtype">char</span> *alpn_list[10];</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_MEMORY_BUFFER_ALLOC_C)</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;<span class="preprocessor"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> alloc_buf[100000];</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    <span class="keywordtype">int</span> i;</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="keywordtype">char</span> *p, *q;</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> *list;</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_MEMORY_BUFFER_ALLOC_C)</span></div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="preprocessor"></span>    <a class="code" href="memory__buffer__alloc_8h.html#ac70d134be54133c272d8eab2cb85dfbf" title="Initialize use of stack-based memory allocator. The stack-based allocator does memory management insi...">mbedtls_memory_buffer_alloc_init</a>( alloc_buf, <span class="keyword">sizeof</span>(alloc_buf) );</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;<span class="comment">     * Make sure memory references are valid in case we exit early.</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    <a class="code" href="net_8h.html#aed7458e19fc1b4794f3a23aa3df49543" title="Initialize a context Just makes the context ready to be used or freed safely. ">mbedtls_net_init</a>( &amp;client_fd );</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    <a class="code" href="net_8h.html#aed7458e19fc1b4794f3a23aa3df49543" title="Initialize a context Just makes the context ready to be used or freed safely. ">mbedtls_net_init</a>( &amp;listen_fd );</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <a class="code" href="ssl_8h.html#a8560dea66d7830a11874188727ec4c45" title="Initialize an SSL context Just makes the context ready for mbetls_ssl_setup() or mbedtls_ssl_free() ...">mbedtls_ssl_init</a>( &amp;ssl );</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <a class="code" href="ssl_8h.html#aba55bcda50a47e83803e31a8db7c9a86" title="Initialize an SSL configuration context Just makes the context ready for mbedtls_ssl_config_defaults(...">mbedtls_ssl_config_init</a>( &amp;conf );</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    <a class="code" href="ctr__drbg_8h.html#a70dbec5e03601bf437ec488f2645743b" title="CTR_DRBG context initialization Makes the context ready for mbetls_ctr_drbg_seed() or mbedtls_ctr_drb...">mbedtls_ctr_drbg_init</a>( &amp;ctr_drbg );</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_X509_CRT_PARSE_C)</span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="preprocessor"></span>    <a class="code" href="group__x509__module.html#ga016dd06bc770e77b84005f305df20ed1" title="Initialize a certificate (chain) ">mbedtls_x509_crt_init</a>( &amp;cacert );</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <a class="code" href="group__x509__module.html#ga016dd06bc770e77b84005f305df20ed1" title="Initialize a certificate (chain) ">mbedtls_x509_crt_init</a>( &amp;srvcert );</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <a class="code" href="pk_8h.html#a999d1160bb30c03d0c4382c3a9b0aa89" title="Initialize a mbedtls_pk_context (as NONE) ">mbedtls_pk_init</a>( &amp;pkey );</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <a class="code" href="group__x509__module.html#ga016dd06bc770e77b84005f305df20ed1" title="Initialize a certificate (chain) ">mbedtls_x509_crt_init</a>( &amp;srvcert2 );</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <a class="code" href="pk_8h.html#a999d1160bb30c03d0c4382c3a9b0aa89" title="Initialize a mbedtls_pk_context (as NONE) ">mbedtls_pk_init</a>( &amp;pkey2 );</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_DHM_C) &amp;&amp; defined(MBEDTLS_FS_IO)</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="preprocessor"></span>    <a class="code" href="dhm_8h.html#abf5ead59678b6ca8892b3c052452f5ac" title="Initialize DHM context. ">mbedtls_dhm_init</a>( &amp;dhm );</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_SSL_CACHE_C)</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="preprocessor"></span>    <a class="code" href="ssl__cache_8h.html#a90886fd9ad56471c5ebaed2e05086cd5" title="Initialize an SSL cache context. ">mbedtls_ssl_cache_init</a>( &amp;cache );</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_SSL_SESSION_TICKETS)</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="preprocessor"></span>    <a class="code" href="ssl__ticket_8h.html#a07765b563037998d820dc8a1272e1ee0" title="Initialize a ticket context. (Just make it ready for mbedtls_ssl_ticket_setup() or mbedtls_ssl_ticket...">mbedtls_ssl_ticket_init</a>( &amp;ticket_ctx );</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_SSL_ALPN)</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="preprocessor"></span>    memset( (<span class="keywordtype">void</span> *) alpn_list, 0, <span class="keyword">sizeof</span>( alpn_list ) );</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_SSL_COOKIE_C)</span></div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;<span class="preprocessor"></span>    <a class="code" href="ssl__cookie_8h.html#affed42a7313e08576aad621f25d5c4f3" title="Initialize cookie context. ">mbedtls_ssl_cookie_init</a>( &amp;cookie_ctx );</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;<span class="preprocessor">#if !defined(_WIN32)</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;<span class="preprocessor"></span>    <span class="comment">/* Abort cleanly on SIGTERM and SIGINT */</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    signal( SIGTERM, term_handler );</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    signal( SIGINT, term_handler );</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    <span class="keywordflow">if</span>( argc == 0 )</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    {</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    usage:</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        <span class="keywordflow">if</span>( ret == 0 )</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;            ret = 1;</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        mbedtls_printf( USAGE );</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;        list = <a class="code" href="ssl_8h.html#aa475d287496d8a93a236a9b91b71dc87" title="Returns the list of ciphersuites supported by the SSL/TLS module. ">mbedtls_ssl_list_ciphersuites</a>();</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;        <span class="keywordflow">while</span>( *list )</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;        {</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;            mbedtls_printf(<span class="stringliteral">&quot; %-42s&quot;</span>, <a class="code" href="ssl_8h.html#ada9a0169e4712521049117d29b91e1e5" title="Return the name of the ciphersuite associated with the given ID. ">mbedtls_ssl_get_ciphersuite_name</a>( *list ) );</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;            list++;</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;            <span class="keywordflow">if</span>( !*list )</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;            mbedtls_printf(<span class="stringliteral">&quot; %s\n&quot;</span>, <a class="code" href="ssl_8h.html#ada9a0169e4712521049117d29b91e1e5" title="Return the name of the ciphersuite associated with the given ID. ">mbedtls_ssl_get_ciphersuite_name</a>( *list ) );</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;            list++;</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        }</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;        mbedtls_printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    }</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    opt.server_addr         = DFL_SERVER_ADDR;</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    opt.server_port         = DFL_SERVER_PORT;</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    opt.debug_level         = DFL_DEBUG_LEVEL;</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    opt.nbio                = DFL_NBIO;</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    opt.read_timeout        = DFL_READ_TIMEOUT;</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    opt.ca_file             = DFL_CA_FILE;</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    opt.ca_path             = DFL_CA_PATH;</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    opt.crt_file            = DFL_CRT_FILE;</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    opt.key_file            = DFL_KEY_FILE;</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    opt.crt_file2           = DFL_CRT_FILE2;</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    opt.key_file2           = DFL_KEY_FILE2;</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    opt.psk                 = DFL_PSK;</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    opt.psk_identity        = DFL_PSK_IDENTITY;</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    opt.psk_list            = DFL_PSK_LIST;</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    opt.force_ciphersuite[0]= DFL_FORCE_CIPHER;</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    opt.version_suites      = DFL_VERSION_SUITES;</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    opt.renegotiation       = DFL_RENEGOTIATION;</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    opt.allow_legacy        = DFL_ALLOW_LEGACY;</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    opt.renegotiate         = DFL_RENEGOTIATE;</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;    opt.renego_delay        = DFL_RENEGO_DELAY;</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    opt.renego_period       = DFL_RENEGO_PERIOD;</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    opt.exchanges           = DFL_EXCHANGES;</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;    opt.min_version         = DFL_MIN_VERSION;</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    opt.max_version         = DFL_MAX_VERSION;</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    opt.arc4                = DFL_ARC4;</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    opt.auth_mode           = DFL_AUTH_MODE;</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    opt.mfl_code            = DFL_MFL_CODE;</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    opt.trunc_hmac          = DFL_TRUNC_HMAC;</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    opt.tickets             = DFL_TICKETS;</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    opt.ticket_timeout      = DFL_TICKET_TIMEOUT;</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    opt.cache_max           = DFL_CACHE_MAX;</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    opt.cache_timeout       = DFL_CACHE_TIMEOUT;</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    opt.sni                 = DFL_SNI;</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    opt.alpn_string         = DFL_ALPN_STRING;</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    opt.dhm_file            = DFL_DHM_FILE;</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    opt.transport           = DFL_TRANSPORT;</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    opt.cookies             = DFL_COOKIES;</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    opt.anti_replay         = DFL_ANTI_REPLAY;</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    opt.hs_to_min           = DFL_HS_TO_MIN;</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    opt.hs_to_max           = DFL_HS_TO_MAX;</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    opt.badmac_limit        = DFL_BADMAC_LIMIT;</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    opt.extended_ms         = DFL_EXTENDED_MS;</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    opt.etm                 = DFL_ETM;</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="keywordflow">for</span>( i = 1; i &lt; argc; i++ )</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    {</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;        p = argv[i];</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        <span class="keywordflow">if</span>( ( q = strchr( p, <span class="charliteral">&#39;=&#39;</span> ) ) == NULL )</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;            <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;        *q++ = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;server_port&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;            opt.server_port = q;</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;server_addr&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;            opt.server_addr = q;</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;dtls&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        {</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;            <span class="keywordtype">int</span> t = atoi( q );</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;            <span class="keywordflow">if</span>( t == 0 )</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;                opt.transport = <a class="code" href="ssl_8h.html#acf690cf4772ff3e2df4b8295275e6fc7">MBEDTLS_SSL_TRANSPORT_STREAM</a>;</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( t == 1 )</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;                opt.transport = <a class="code" href="ssl_8h.html#ac00527bc4661e5d7f2df5e7e96a6a896">MBEDTLS_SSL_TRANSPORT_DATAGRAM</a>;</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;        }</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;debug_level&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;        {</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;            opt.debug_level = atoi( q );</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;            <span class="keywordflow">if</span>( opt.debug_level &lt; 0 || opt.debug_level &gt; 65535 )</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;        }</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;nbio&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        {</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;            opt.nbio = atoi( q );</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;            <span class="keywordflow">if</span>( opt.nbio &lt; 0 || opt.nbio &gt; 2 )</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        }</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;read_timeout&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;            opt.read_timeout = atoi( q );</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;ca_file&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;            opt.ca_file = q;</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;ca_path&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;            opt.ca_path = q;</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;crt_file&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;            opt.crt_file = q;</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;key_file&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;            opt.key_file = q;</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;crt_file2&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;            opt.crt_file2 = q;</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;key_file2&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;            opt.key_file2 = q;</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;dhm_file&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;            opt.dhm_file = q;</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;psk&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;            opt.psk = q;</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;psk_identity&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;            opt.psk_identity = q;</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;psk_list&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;            opt.psk_list = q;</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;force_ciphersuite&quot;</span> ) == 0 )</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;        {</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;            opt.force_ciphersuite[0] = <a class="code" href="ssl_8h.html#a9914cdf5533e813e1ea7ca52981aa006" title="Return the ID of the ciphersuite associated with the given name. ">mbedtls_ssl_get_ciphersuite_id</a>( q );</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;            <span class="keywordflow">if</span>( opt.force_ciphersuite[0] == 0 )</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;            {</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;                ret = 2;</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;            }</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;            opt.force_ciphersuite[1] = 0;</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        }</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;version_suites&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;            opt.version_suites = q;</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;renegotiation&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;        {</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;            opt.renegotiation = (atoi( q )) ? MBEDTLS_SSL_RENEGOTIATION_ENABLED :</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                                              MBEDTLS_SSL_RENEGOTIATION_DISABLED;</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        }</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;allow_legacy&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;        {</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;            <span class="keywordflow">switch</span>( atoi( q ) )</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;            {</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;                <span class="keywordflow">case</span> -1: opt.allow_legacy = MBEDTLS_SSL_LEGACY_BREAK_HANDSHAKE; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;                <span class="keywordflow">case</span> 0:  opt.allow_legacy = MBEDTLS_SSL_LEGACY_NO_RENEGOTIATION; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;                <span class="keywordflow">case</span> 1:  opt.allow_legacy = MBEDTLS_SSL_LEGACY_ALLOW_RENEGOTIATION; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                <span class="keywordflow">default</span>: <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;            }</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;        }</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;renegotiate&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        {</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;            opt.renegotiate = atoi( q );</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;            <span class="keywordflow">if</span>( opt.renegotiate &lt; 0 || opt.renegotiate &gt; 1 )</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        }</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;renego_delay&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;        {</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;            opt.renego_delay = atoi( q );</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;        }</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;renego_period&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;        {</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;            opt.renego_period = atoi( q );</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;            <span class="keywordflow">if</span>( opt.renego_period &lt; 2 || opt.renego_period &gt; 255 )</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        }</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;exchanges&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;        {</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;            opt.exchanges = atoi( q );</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;            <span class="keywordflow">if</span>( opt.exchanges &lt; 0 )</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        }</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;min_version&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;        {</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;            <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;ssl3&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;                opt.min_version = <a class="code" href="ssl_8h.html#a29f89cb1c3fa78a8c57f683495feff15">MBEDTLS_SSL_MINOR_VERSION_0</a>;</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;tls1&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;                opt.min_version = <a class="code" href="ssl_8h.html#a364e4bfbd4f909a2aa7ac5eb31c6b1b2">MBEDTLS_SSL_MINOR_VERSION_1</a>;</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;tls1_1&quot;</span> ) == 0 ||</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                     strcmp( q, <span class="stringliteral">&quot;dtls1&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;                opt.min_version = <a class="code" href="ssl_8h.html#a9fe59361b834e334b80efacb10f8e33a">MBEDTLS_SSL_MINOR_VERSION_2</a>;</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;tls1_2&quot;</span> ) == 0 ||</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;                     strcmp( q, <span class="stringliteral">&quot;dtls1_2&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;                opt.min_version = <a class="code" href="ssl_8h.html#a3c5a90b4b4aded2190f31f7d4c670cb4">MBEDTLS_SSL_MINOR_VERSION_3</a>;</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;        }</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;max_version&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;        {</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;            <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;ssl3&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;                opt.max_version = <a class="code" href="ssl_8h.html#a29f89cb1c3fa78a8c57f683495feff15">MBEDTLS_SSL_MINOR_VERSION_0</a>;</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;tls1&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;                opt.max_version = <a class="code" href="ssl_8h.html#a364e4bfbd4f909a2aa7ac5eb31c6b1b2">MBEDTLS_SSL_MINOR_VERSION_1</a>;</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;tls1_1&quot;</span> ) == 0 ||</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;                     strcmp( q, <span class="stringliteral">&quot;dtls1&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;                opt.max_version = <a class="code" href="ssl_8h.html#a9fe59361b834e334b80efacb10f8e33a">MBEDTLS_SSL_MINOR_VERSION_2</a>;</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;tls1_2&quot;</span> ) == 0 ||</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                     strcmp( q, <span class="stringliteral">&quot;dtls1_2&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                opt.max_version = <a class="code" href="ssl_8h.html#a3c5a90b4b4aded2190f31f7d4c670cb4">MBEDTLS_SSL_MINOR_VERSION_3</a>;</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        }</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;arc4&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;        {</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;            <span class="keywordflow">switch</span>( atoi( q ) )</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;            {</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;                <span class="keywordflow">case</span> 0:     opt.arc4 = MBEDTLS_SSL_ARC4_DISABLED;   <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;                <span class="keywordflow">case</span> 1:     opt.arc4 = MBEDTLS_SSL_ARC4_ENABLED;    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;                <span class="keywordflow">default</span>:    <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;            }</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        }</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;force_version&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;        {</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;            <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;ssl3&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;            {</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;                opt.min_version = <a class="code" href="ssl_8h.html#a29f89cb1c3fa78a8c57f683495feff15">MBEDTLS_SSL_MINOR_VERSION_0</a>;</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;                opt.max_version = <a class="code" href="ssl_8h.html#a29f89cb1c3fa78a8c57f683495feff15">MBEDTLS_SSL_MINOR_VERSION_0</a>;</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;            }</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;tls1&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;            {</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;                opt.min_version = <a class="code" href="ssl_8h.html#a364e4bfbd4f909a2aa7ac5eb31c6b1b2">MBEDTLS_SSL_MINOR_VERSION_1</a>;</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;                opt.max_version = <a class="code" href="ssl_8h.html#a364e4bfbd4f909a2aa7ac5eb31c6b1b2">MBEDTLS_SSL_MINOR_VERSION_1</a>;</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;            }</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;tls1_1&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;            {</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;                opt.min_version = <a class="code" href="ssl_8h.html#a9fe59361b834e334b80efacb10f8e33a">MBEDTLS_SSL_MINOR_VERSION_2</a>;</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;                opt.max_version = <a class="code" href="ssl_8h.html#a9fe59361b834e334b80efacb10f8e33a">MBEDTLS_SSL_MINOR_VERSION_2</a>;</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;            }</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;tls1_2&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;            {</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;                opt.min_version = <a class="code" href="ssl_8h.html#a3c5a90b4b4aded2190f31f7d4c670cb4">MBEDTLS_SSL_MINOR_VERSION_3</a>;</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;                opt.max_version = <a class="code" href="ssl_8h.html#a3c5a90b4b4aded2190f31f7d4c670cb4">MBEDTLS_SSL_MINOR_VERSION_3</a>;</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;            }</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;dtls1&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;            {</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;                opt.min_version = <a class="code" href="ssl_8h.html#a9fe59361b834e334b80efacb10f8e33a">MBEDTLS_SSL_MINOR_VERSION_2</a>;</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;                opt.max_version = <a class="code" href="ssl_8h.html#a9fe59361b834e334b80efacb10f8e33a">MBEDTLS_SSL_MINOR_VERSION_2</a>;</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;                opt.transport = <a class="code" href="ssl_8h.html#ac00527bc4661e5d7f2df5e7e96a6a896">MBEDTLS_SSL_TRANSPORT_DATAGRAM</a>;</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;            }</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;dtls1_2&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;            {</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;                opt.min_version = <a class="code" href="ssl_8h.html#a3c5a90b4b4aded2190f31f7d4c670cb4">MBEDTLS_SSL_MINOR_VERSION_3</a>;</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;                opt.max_version = <a class="code" href="ssl_8h.html#a3c5a90b4b4aded2190f31f7d4c670cb4">MBEDTLS_SSL_MINOR_VERSION_3</a>;</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;                opt.transport = <a class="code" href="ssl_8h.html#ac00527bc4661e5d7f2df5e7e96a6a896">MBEDTLS_SSL_TRANSPORT_DATAGRAM</a>;</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;            }</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;        }</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;auth_mode&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;        {</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;            <span class="keywordflow">if</span>( ( opt.auth_mode = get_auth_mode( q ) ) &lt; 0 )</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        }</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;max_frag_len&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;        {</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;            <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;512&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;                opt.mfl_code = <a class="code" href="ssl_8h.html#a148f83e96299be6220fc3c922cfb58d5">MBEDTLS_SSL_MAX_FRAG_LEN_512</a>;</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;1024&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;                opt.mfl_code = <a class="code" href="ssl_8h.html#ad2d55e32e6514fb146b8681ea914b991">MBEDTLS_SSL_MAX_FRAG_LEN_1024</a>;</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;2048&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;                opt.mfl_code = <a class="code" href="ssl_8h.html#a08a6eb65d87c8d6565f47689d4e80bd3">MBEDTLS_SSL_MAX_FRAG_LEN_2048</a>;</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( q, <span class="stringliteral">&quot;4096&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;                opt.mfl_code = <a class="code" href="ssl_8h.html#adfe756e3f577397f4a3328b0e927bb6a">MBEDTLS_SSL_MAX_FRAG_LEN_4096</a>;</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;        }</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;alpn&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;        {</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;            opt.alpn_string = q;</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;        }</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;trunc_hmac&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        {</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;            <span class="keywordflow">switch</span>( atoi( q ) )</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;            {</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;                <span class="keywordflow">case</span> 0: opt.trunc_hmac = MBEDTLS_SSL_TRUNC_HMAC_DISABLED; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;                <span class="keywordflow">case</span> 1: opt.trunc_hmac = MBEDTLS_SSL_TRUNC_HMAC_ENABLED; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;                <span class="keywordflow">default</span>: <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;            }</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        }</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;extended_ms&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        {</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;            <span class="keywordflow">switch</span>( atoi( q ) )</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;            {</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;                <span class="keywordflow">case</span> 0: opt.extended_ms = MBEDTLS_SSL_EXTENDED_MS_DISABLED; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;                <span class="keywordflow">case</span> 1: opt.extended_ms = MBEDTLS_SSL_EXTENDED_MS_ENABLED; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;                <span class="keywordflow">default</span>: <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;            }</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        }</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;etm&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        {</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;            <span class="keywordflow">switch</span>( atoi( q ) )</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;            {</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;                <span class="keywordflow">case</span> 0: opt.etm = MBEDTLS_SSL_ETM_DISABLED; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;                <span class="keywordflow">case</span> 1: opt.etm = MBEDTLS_SSL_ETM_ENABLED; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;                <span class="keywordflow">default</span>: <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;            }</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;        }</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;tickets&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;        {</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;            opt.tickets = atoi( q );</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;            <span class="keywordflow">if</span>( opt.tickets &lt; 0 || opt.tickets &gt; 1 )</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;        }</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;ticket_timeout&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;        {</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;            opt.ticket_timeout = atoi( q );</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;            <span class="keywordflow">if</span>( opt.ticket_timeout &lt; 0 )</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;        }</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;cache_max&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;        {</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;            opt.cache_max = atoi( q );</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;            <span class="keywordflow">if</span>( opt.cache_max &lt; 0 )</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;        }</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;cache_timeout&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;        {</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;            opt.cache_timeout = atoi( q );</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;            <span class="keywordflow">if</span>( opt.cache_timeout &lt; 0 )</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;        }</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;cookies&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;        {</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;            opt.cookies = atoi( q );</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;            <span class="keywordflow">if</span>( opt.cookies &lt; -1 || opt.cookies &gt; 1)</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        }</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;anti_replay&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        {</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;            opt.anti_replay = atoi( q );</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;            <span class="keywordflow">if</span>( opt.anti_replay &lt; 0 || opt.anti_replay &gt; 1)</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;        }</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;badmac_limit&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;        {</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;            opt.badmac_limit = atoi( q );</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;            <span class="keywordflow">if</span>( opt.badmac_limit &lt; 0 )</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;        }</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;hs_timeout&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;        {</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;            <span class="keywordflow">if</span>( ( p = strchr( q, <span class="charliteral">&#39;-&#39;</span> ) ) == NULL )</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;            *p++ = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;            opt.hs_to_min = atoi( q );</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;            opt.hs_to_max = atoi( p );</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;            <span class="keywordflow">if</span>( opt.hs_to_min == 0 || opt.hs_to_max &lt; opt.hs_to_min )</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;        }</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp( p, <span class="stringliteral">&quot;sni&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;        {</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;            opt.sni = q;</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;        }</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;            <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;    }</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_DEBUG_C)</span></div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;<span class="preprocessor"></span>    <a class="code" href="debug_8h.html#a6629362e96b43725ace95c8ff01d9985" title="Set the level threshold to handle globally. Messages that have a level over the threshold value are i...">mbedtls_debug_set_threshold</a>( opt.debug_level );</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;    <span class="keywordflow">if</span>( opt.force_ciphersuite[0] &gt; 0 )</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    {</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;        <span class="keyword">const</span> <a class="code" href="structmbedtls__ssl__ciphersuite__t.html" title="This structure is used for storing ciphersuite information. ">mbedtls_ssl_ciphersuite_t</a> *ciphersuite_info;</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;        ciphersuite_info = mbedtls_ssl_ciphersuite_from_id( opt.force_ciphersuite[0] );</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;        <span class="keywordflow">if</span>( opt.max_version != -1 &amp;&amp;</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;            ciphersuite_info-&gt;min_minor_ver &gt; opt.max_version )</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;        {</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;            mbedtls_printf(<span class="stringliteral">&quot;forced ciphersuite not allowed with this protocol version\n&quot;</span>);</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;            ret = 2;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;            <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;        }</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;        <span class="keywordflow">if</span>( opt.min_version != -1 &amp;&amp;</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;            ciphersuite_info-&gt;max_minor_ver &lt; opt.min_version )</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;        {</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;            mbedtls_printf(<span class="stringliteral">&quot;forced ciphersuite not allowed with this protocol version\n&quot;</span>);</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;            ret = 2;</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;            <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;        }</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;        <span class="comment">/* If we select a version that&#39;s not supported by</span></div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;<span class="comment">         * this suite, then there will be no common ciphersuite... */</span></div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;        <span class="keywordflow">if</span>( opt.max_version == -1 ||</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;            opt.max_version &gt; ciphersuite_info-&gt;max_minor_ver )</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;        {</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;            opt.max_version = ciphersuite_info-&gt;max_minor_ver;</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;        }</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;        <span class="keywordflow">if</span>( opt.min_version &lt; ciphersuite_info-&gt;min_minor_ver )</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;        {</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;            opt.min_version = ciphersuite_info-&gt;min_minor_ver;</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;            <span class="comment">/* DTLS starts with TLS 1.1 */</span></div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;            <span class="keywordflow">if</span>( opt.transport == <a class="code" href="ssl_8h.html#ac00527bc4661e5d7f2df5e7e96a6a896">MBEDTLS_SSL_TRANSPORT_DATAGRAM</a> &amp;&amp;</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;                opt.min_version &lt; <a class="code" href="ssl_8h.html#a9fe59361b834e334b80efacb10f8e33a">MBEDTLS_SSL_MINOR_VERSION_2</a> )</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;                opt.min_version = <a class="code" href="ssl_8h.html#a9fe59361b834e334b80efacb10f8e33a">MBEDTLS_SSL_MINOR_VERSION_2</a>;</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;        }</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;        <span class="comment">/* Enable RC4 if needed and not explicitly disabled */</span></div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;        <span class="keywordflow">if</span>( ciphersuite_info-&gt;cipher == MBEDTLS_CIPHER_ARC4_128 )</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;        {</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;            <span class="keywordflow">if</span>( opt.arc4 == MBEDTLS_SSL_ARC4_DISABLED )</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;            {</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;                mbedtls_printf(<span class="stringliteral">&quot;forced RC4 ciphersuite with RC4 disabled\n&quot;</span>);</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;                ret = 2;</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;            }</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;            opt.arc4 = MBEDTLS_SSL_ARC4_ENABLED;</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;        }</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;    }</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    <span class="keywordflow">if</span>( opt.version_suites != NULL )</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    {</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span> *name[4] = { 0 };</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        <span class="comment">/* Parse 4-element coma-separated list */</span></div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;        <span class="keywordflow">for</span>( i = 0, p = (<span class="keywordtype">char</span> *) opt.version_suites;</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;             i &lt; 4 &amp;&amp; *p != <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;             i++ )</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;        {</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;            name[i] = p;</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;            <span class="comment">/* Terminate the current string and move on to next one */</span></div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;            <span class="keywordflow">while</span>( *p != <span class="charliteral">&#39;,&#39;</span> &amp;&amp; *p != <span class="charliteral">&#39;\0&#39;</span> )</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;                p++;</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;            <span class="keywordflow">if</span>( *p == <span class="charliteral">&#39;,&#39;</span> )</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;                *p++ = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        }</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        <span class="keywordflow">if</span>( i != 4 )</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        {</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot;too few values for version_suites\n&quot;</span> );</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;            ret = 1;</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        }</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;        memset( version_suites, 0, <span class="keyword">sizeof</span>( version_suites ) );</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;        <span class="comment">/* Get the suites identifiers from their name */</span></div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        <span class="keywordflow">for</span>( i = 0; i &lt; 4; i++ )</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;        {</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;            version_suites[i][0] = <a class="code" href="ssl_8h.html#a9914cdf5533e813e1ea7ca52981aa006" title="Return the ID of the ciphersuite associated with the given name. ">mbedtls_ssl_get_ciphersuite_id</a>( name[i] );</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;            <span class="keywordflow">if</span>( version_suites[i][0] == 0 )</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;            {</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                mbedtls_printf( <span class="stringliteral">&quot;unknown ciphersuite: &#39;%s&#39;\n&quot;</span>, name[i] );</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;                ret = 2;</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;                <span class="keywordflow">goto</span> usage;</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;            }</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        }</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;    }</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_KEY_EXCHANGE__SOME__PSK_ENABLED)</span></div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;<span class="preprocessor"></span>    <span class="comment">/*</span></div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;<span class="comment">     * Unhexify the pre-shared key and parse the list if any given</span></div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;    <span class="keywordflow">if</span>( unhexify( psk, opt.psk, &amp;psk_len ) != 0 )</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;    {</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot;pre-shared key not valid hex\n&quot;</span> );</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;    }</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;    <span class="keywordflow">if</span>( opt.psk_list != NULL )</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;    {</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;        <span class="keywordflow">if</span>( ( psk_info = psk_parse( opt.psk_list ) ) == NULL )</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;        {</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot;psk_list invalid&quot;</span> );</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;        }</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    }</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_KEY_EXCHANGE__SOME__PSK_ENABLED */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_ALPN)</span></div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.alpn_string != NULL )</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;    {</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;        p = (<span class="keywordtype">char</span> *) opt.alpn_string;</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;        i = 0;</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;        <span class="comment">/* Leave room for a final NULL in alpn_list */</span></div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;        <span class="keywordflow">while</span>( i &lt; (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span> alpn_list - 1 &amp;&amp; *p != <span class="charliteral">&#39;\0&#39;</span> )</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;        {</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;            alpn_list[i++] = p;</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;            <span class="comment">/* Terminate the current string and move on to next one */</span></div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;            <span class="keywordflow">while</span>( *p != <span class="charliteral">&#39;,&#39;</span> &amp;&amp; *p != <span class="charliteral">&#39;\0&#39;</span> )</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;                p++;</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;            <span class="keywordflow">if</span>( *p == <span class="charliteral">&#39;,&#39;</span> )</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;                *p++ = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;        }</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;    }</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_SSL_ALPN */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;<span class="comment">     * 0. Initialize the RNG and the session data</span></div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot;\n  . Seeding the random number generator...&quot;</span> );</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;    fflush( stdout );</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;    <a class="code" href="entropy_8h.html#aa901e027093c6fe65dee5760db78aced" title="Initialize the context. ">mbedtls_entropy_init</a>( &amp;entropy );</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    <span class="keywordflow">if</span>( ( ret = <a class="code" href="ctr__drbg_8h.html#ad93d675f998550b4478c1fe6f4f34ebc" title="CTR_DRBG initial seeding Seed and setup entropy source for future reseeds. ">mbedtls_ctr_drbg_seed</a>( &amp;ctr_drbg, <a class="code" href="entropy_8h.html#a81765f6cdf4e5111bcb9f4324f3234cb" title="Retrieve entropy from the accumulator (Maximum length: MBEDTLS_ENTROPY_BLOCK_SIZE) (Thread-safe if MB...">mbedtls_entropy_func</a>, &amp;entropy,</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;                               (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) pers,</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;                               strlen( pers ) ) ) != 0 )</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    {</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ctr_drbg_seed returned -0x%x\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;    }</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot; ok\n&quot;</span> );</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_X509_CRT_PARSE_C)</span></div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;<span class="preprocessor"></span>    <span class="comment">/*</span></div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;<span class="comment">     * 1.1. Load the trusted CA</span></div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot;  . Loading the CA root certificate ...&quot;</span> );</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    fflush( stdout );</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_FS_IO)</span></div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( strlen( opt.ca_path ) )</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;        <span class="keywordflow">if</span>( strcmp( opt.ca_path, <span class="stringliteral">&quot;none&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;            ret = 0;</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;            ret = <a class="code" href="group__x509__module.html#ga571fc89b9f3217ab3dd67bd7af905066" title="Load one or more certificate files from a path and add them to the chained list. Parses permissively...">mbedtls_x509_crt_parse_path</a>( &amp;cacert, opt.ca_path );</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strlen( opt.ca_file ) )</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;        <span class="keywordflow">if</span>( strcmp( opt.ca_file, <span class="stringliteral">&quot;none&quot;</span> ) == 0 )</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;            ret = 0;</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;            ret = <a class="code" href="group__x509__module.html#gad4da63133d3590aa311488497d4c38ec" title="Load one or more certificates and add them to the chained list. Parses permissively. If some certificates can be parsed, the result is the number of failed certificates it encountered. If none complete correctly, the first error is returned. ">mbedtls_x509_crt_parse_file</a>( &amp;cacert, opt.ca_file );</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_CERTS_C)</span></div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">for</span>( i = 0; mbedtls_test_cas[i] != NULL; i++ )</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;        {</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;            ret = <a class="code" href="group__x509__module.html#ga033567483649030f7f859db4f4cb7e14" title="Parse one or more certificates and add them to the chained list. Parses permissively. If some certificates can be parsed, the result is the number of failed certificates it encountered. If none complete correctly, the first error is returned. ">mbedtls_x509_crt_parse</a>( &amp;cacert,</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;                                  (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) mbedtls_test_cas[i],</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;                                  mbedtls_test_cas_len[i] );</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;            <span class="keywordflow">if</span>( ret != 0 )</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;        }</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;<span class="preprocessor"></span>    {</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;        ret = 1;</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;        mbedtls_printf(<span class="stringliteral">&quot;MBEDTLS_CERTS_C not defined.&quot;</span>);</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    }</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( ret &lt; 0 )</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;    {</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; failed\n  !  mbedtls_x509_crt_parse returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;    }</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot; ok (%d skipped)\n&quot;</span>, ret );</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;<span class="comment">     * 1.2. Load own certificate and private key</span></div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot;  . Loading the server cert. and key...&quot;</span> );</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    fflush( stdout );</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_FS_IO)</span></div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( strlen( opt.crt_file ) &amp;&amp; strcmp( opt.crt_file, <span class="stringliteral">&quot;none&quot;</span> ) != 0 )</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;    {</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;        key_cert_init++;</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;        <span class="keywordflow">if</span>( ( ret = <a class="code" href="group__x509__module.html#gad4da63133d3590aa311488497d4c38ec" title="Load one or more certificates and add them to the chained list. Parses permissively. If some certificates can be parsed, the result is the number of failed certificates it encountered. If none complete correctly, the first error is returned. ">mbedtls_x509_crt_parse_file</a>( &amp;srvcert, opt.crt_file ) ) != 0 )</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;        {</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  !  mbedtls_x509_crt_parse_file returned -0x%x\n\n&quot;</span>,</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;                    -ret );</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;        }</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;    }</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;    <span class="keywordflow">if</span>( strlen( opt.key_file ) &amp;&amp; strcmp( opt.key_file, <span class="stringliteral">&quot;none&quot;</span> ) != 0 )</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;    {</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;        key_cert_init++;</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;        <span class="keywordflow">if</span>( ( ret = <a class="code" href="pk_8h.html#a935d710e542409462d0209f2381da83e" title="Load and parse a private key. ">mbedtls_pk_parse_keyfile</a>( &amp;pkey, opt.key_file, <span class="stringliteral">&quot;&quot;</span> ) ) != 0 )</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;        {</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  !  mbedtls_pk_parse_keyfile returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;        }</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    }</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    <span class="keywordflow">if</span>( key_cert_init == 1 )</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;    {</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; failed\n  !  crt_file without key_file or vice-versa\n\n&quot;</span> );</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;    }</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    <span class="keywordflow">if</span>( strlen( opt.crt_file2 ) &amp;&amp; strcmp( opt.crt_file2, <span class="stringliteral">&quot;none&quot;</span> ) != 0 )</div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;    {</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;        key_cert_init2++;</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;        <span class="keywordflow">if</span>( ( ret = <a class="code" href="group__x509__module.html#gad4da63133d3590aa311488497d4c38ec" title="Load one or more certificates and add them to the chained list. Parses permissively. If some certificates can be parsed, the result is the number of failed certificates it encountered. If none complete correctly, the first error is returned. ">mbedtls_x509_crt_parse_file</a>( &amp;srvcert2, opt.crt_file2 ) ) != 0 )</div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;        {</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  !  mbedtls_x509_crt_parse_file(2) returned -0x%x\n\n&quot;</span>,</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;                    -ret );</div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;        }</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    }</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    <span class="keywordflow">if</span>( strlen( opt.key_file2 ) &amp;&amp; strcmp( opt.key_file2, <span class="stringliteral">&quot;none&quot;</span> ) != 0 )</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;    {</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;        key_cert_init2++;</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;        <span class="keywordflow">if</span>( ( ret = <a class="code" href="pk_8h.html#a935d710e542409462d0209f2381da83e" title="Load and parse a private key. ">mbedtls_pk_parse_keyfile</a>( &amp;pkey2, opt.key_file2, <span class="stringliteral">&quot;&quot;</span> ) ) != 0 )</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;        {</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  !  mbedtls_pk_parse_keyfile(2) returned -0x%x\n\n&quot;</span>,</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;                    -ret );</div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;        }</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;    }</div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;    <span class="keywordflow">if</span>( key_cert_init2 == 1 )</div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;    {</div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; failed\n  !  crt_file2 without key_file2 or vice-versa\n\n&quot;</span> );</div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    }</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( key_cert_init == 0 &amp;&amp;</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;        strcmp( opt.crt_file, <span class="stringliteral">&quot;none&quot;</span> ) != 0 &amp;&amp;</div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;        strcmp( opt.key_file, <span class="stringliteral">&quot;none&quot;</span> ) != 0 &amp;&amp;</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;        key_cert_init2 == 0 &amp;&amp;</div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;        strcmp( opt.crt_file2, <span class="stringliteral">&quot;none&quot;</span> ) != 0 &amp;&amp;</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;        strcmp( opt.key_file2, <span class="stringliteral">&quot;none&quot;</span> ) != 0 )</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;    {</div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;<span class="preprocessor">#if !defined(MBEDTLS_CERTS_C)</span></div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;<span class="preprocessor"></span>        mbedtls_printf( <span class="stringliteral">&quot;Not certificated or key provided, and \n&quot;</span></div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;                <span class="stringliteral">&quot;MBEDTLS_CERTS_C not defined!\n&quot;</span> );</div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_RSA_C)</span></div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>( ( ret = <a class="code" href="group__x509__module.html#ga033567483649030f7f859db4f4cb7e14" title="Parse one or more certificates and add them to the chained list. Parses permissively. If some certificates can be parsed, the result is the number of failed certificates it encountered. If none complete correctly, the first error is returned. ">mbedtls_x509_crt_parse</a>( &amp;srvcert,</div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;                                    (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) mbedtls_test_srv_crt_rsa,</div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;                                    mbedtls_test_srv_crt_rsa_len ) ) != 0 )</div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;        {</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  !  mbedtls_x509_crt_parse returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;        }</div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;        <span class="keywordflow">if</span>( ( ret = <a class="code" href="pk_8h.html#a072d27dc4143bfd600786232f9417e08" title="Parse a private key in PEM or DER format. ">mbedtls_pk_parse_key</a>( &amp;pkey,</div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;                                  (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) mbedtls_test_srv_key_rsa,</div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;                                  mbedtls_test_srv_key_rsa_len, NULL, 0 ) ) != 0 )</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;        {</div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  !  mbedtls_pk_parse_key returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;        }</div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;        key_cert_init = 2;</div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_RSA_C */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_ECDSA_C)</span></div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>( ( ret = <a class="code" href="group__x509__module.html#ga033567483649030f7f859db4f4cb7e14" title="Parse one or more certificates and add them to the chained list. Parses permissively. If some certificates can be parsed, the result is the number of failed certificates it encountered. If none complete correctly, the first error is returned. ">mbedtls_x509_crt_parse</a>( &amp;srvcert2,</div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;                                    (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) mbedtls_test_srv_crt_ec,</div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;                                    mbedtls_test_srv_crt_ec_len ) ) != 0 )</div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;        {</div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  !  x509_crt_parse2 returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;        }</div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;        <span class="keywordflow">if</span>( ( ret = <a class="code" href="pk_8h.html#a072d27dc4143bfd600786232f9417e08" title="Parse a private key in PEM or DER format. ">mbedtls_pk_parse_key</a>( &amp;pkey2,</div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;                                  (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) mbedtls_test_srv_key_ec,</div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;                                  mbedtls_test_srv_key_ec_len, NULL, 0 ) ) != 0 )</div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;        {</div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  !  pk_parse_key2 returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;        }</div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;        key_cert_init2 = 2;</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_ECDSA_C */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_CERTS_C */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot; ok\n&quot;</span> );</div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_X509_CRT_PARSE_C */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_DHM_C) &amp;&amp; defined(MBEDTLS_FS_IO)</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.dhm_file != NULL )</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;    {</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot;  . Loading DHM parameters...&quot;</span> );</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;        fflush( stdout );</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;        <span class="keywordflow">if</span>( ( ret = <a class="code" href="group__x509__module.html#gae2f53ca5e795b7e8674f092777a5a828" title="Load and parse DHM parameters. ">mbedtls_dhm_parse_dhmfile</a>( &amp;dhm, opt.dhm_file ) ) != 0 )</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;        {</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_dhm_parse_dhmfile returned -0x%04X\n\n&quot;</span>,</div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;                     -ret );</div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;        }</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; ok\n&quot;</span> );</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;    }</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;<span class="preprocessor">#if defined(SNI_OPTION)</span></div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.sni != NULL )</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;    {</div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot;  . Setting up SNI information...&quot;</span> );</div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;        fflush( stdout );</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;</div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;        <span class="keywordflow">if</span>( ( sni_info = sni_parse( opt.sni ) ) == NULL )</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;        {</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n&quot;</span> );</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;        }</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; ok\n&quot;</span> );</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;    }</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* SNI_OPTION */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;<span class="comment">     * 2. Setup the listening TCP socket</span></div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot;  . Bind on %s://%s:%s/ ...&quot;</span>,</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;            opt.transport == <a class="code" href="ssl_8h.html#acf690cf4772ff3e2df4b8295275e6fc7">MBEDTLS_SSL_TRANSPORT_STREAM</a> ? <span class="stringliteral">&quot;tcp&quot;</span> : <span class="stringliteral">&quot;udp&quot;</span>,</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;            opt.server_addr ? opt.server_addr : <span class="stringliteral">&quot;*&quot;</span>,</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;            opt.server_port );</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;    fflush( stdout );</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;    <span class="keywordflow">if</span>( ( ret = <a class="code" href="net_8h.html#aa1cb7fc819153c43a2c75c95d0152c75" title="Create a receiving socket on bind_ip:port in the chosen protocol. If bind_ip == NULL, all interfaces are bound. ">mbedtls_net_bind</a>( &amp;listen_fd, opt.server_addr, opt.server_port,</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;                          opt.transport == <a class="code" href="ssl_8h.html#acf690cf4772ff3e2df4b8295275e6fc7">MBEDTLS_SSL_TRANSPORT_STREAM</a> ?</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;                          <a class="code" href="net_8h.html#a989e1bc1aae7e48ac318d5ddd24efa3b">MBEDTLS_NET_PROTO_TCP</a> : <a class="code" href="net_8h.html#a8d6d212e9f0ea5756fff8d06c46f4f44">MBEDTLS_NET_PROTO_UDP</a> ) ) != 0 )</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;    {</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_net_bind returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;    }</div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;</div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot; ok\n&quot;</span> );</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;<span class="comment">     * 3. Setup stuff</span></div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot;  . Setting up the SSL/TLS structure...&quot;</span> );</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;    fflush( stdout );</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;    <span class="keywordflow">if</span>( ( ret = <a class="code" href="ssl_8h.html#aa1335b65ba57e81accc91ef95454d5a6" title="Load reasonnable default SSL configuration values. (You need to call mbedtls_ssl_config_init() first...">mbedtls_ssl_config_defaults</a>( &amp;conf,</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;                    MBEDTLS_SSL_IS_SERVER,</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;                    opt.<a class="code" href="structmbedtls__ssl__config.html#a63cafd8d131ac7d162406b47bc6565d0">transport</a>,</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;                    MBEDTLS_SSL_PRESET_DEFAULT ) ) != 0 )</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;    {</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ssl_config_defaults returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;    }</div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;</div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;    <span class="keywordflow">if</span>( opt.auth_mode != DFL_AUTH_MODE )</div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;        <a class="code" href="ssl_8h.html#a5695285c9dbfefec295012b566290f37" title="Set the certificate verification mode Default: NONE on server, REQUIRED on client. ">mbedtls_ssl_conf_authmode</a>( &amp;conf, opt.auth_mode );</div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;</div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_PROTO_DTLS)</span></div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.hs_to_min != DFL_HS_TO_MIN || opt.hs_to_max != DFL_HS_TO_MAX )</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;        <a class="code" href="ssl_8h.html#a6625bc4e7ffd535900ef53259cc21651" title="Set retransmit timeout values for the DTLS handshale. (DTLS only, no effect on TLS.) ">mbedtls_ssl_conf_handshake_timeout</a>( &amp;conf, opt.hs_to_min, opt.hs_to_max );</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_SSL_PROTO_DTLS */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_MAX_FRAGMENT_LENGTH)</span></div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( ( ret = <a class="code" href="ssl_8h.html#ac68fda83c26b3078e80f4dfc3b09bb94" title="Set the maximum fragment length to emit and/or negotiate (Default: MBEDTLS_SSL_MAX_CONTENT_LEN, usually 2^14 bytes) (Server: set maximum fragment length to emit, usually negotiated by the client during handshake (Client: set maximum fragment length to emit and negotiate with the server during handshake) ">mbedtls_ssl_conf_max_frag_len</a>( &amp;conf, opt.<a class="code" href="structmbedtls__ssl__config.html#a67e52d2668c7f4bc4f6a872c35a679ab">mfl_code</a> ) ) != 0 )</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;    {</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ssl_conf_max_frag_len returned %d\n\n&quot;</span>, ret );</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;    };</div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_TRUNCATED_HMAC)</span></div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.trunc_hmac != DFL_TRUNC_HMAC )</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;        <a class="code" href="ssl_8h.html#a739b67cfc0350ae4a2c9a2e99737bea7" title="Activate negotiation of truncated HMAC (Default: MBEDTLS_SSL_TRUNC_HMAC_DISABLED) ...">mbedtls_ssl_conf_truncated_hmac</a>( &amp;conf, opt.<a class="code" href="structmbedtls__ssl__config.html#a24bf9d624a2e2432518e9da8ae908db4">trunc_hmac</a> );</div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_EXTENDED_MASTER_SECRET)</span></div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.extended_ms != DFL_EXTENDED_MS )</div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;        <a class="code" href="ssl_8h.html#a133db91d4a1dd44d212ac57e386c23b3" title="Enable or disable Extended Master Secret negotiation. (Default: MBEDTLS_SSL_EXTENDED_MS_ENABLED) ...">mbedtls_ssl_conf_extended_master_secret</a>( &amp;conf, opt.<a class="code" href="structmbedtls__ssl__config.html#ac6ac2c30ac20fc9033913e0de6ffbe93">extended_ms</a> );</div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_ENCRYPT_THEN_MAC)</span></div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.etm != DFL_ETM )</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;        <a class="code" href="ssl_8h.html#afa8a1d55630fec25f2247fc9958eaa53" title="Enable or disable Encrypt-then-MAC (Default: MBEDTLS_SSL_ETM_ENABLED) ">mbedtls_ssl_conf_encrypt_then_mac</a>( &amp;conf, opt.etm );</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_ALPN)</span></div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.alpn_string != NULL )</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;        <span class="keywordflow">if</span>( ( ret = <a class="code" href="ssl_8h.html#ae21135dddd89b2ef273c13e140097f5a" title="Set the supported Application Layer Protocols. ">mbedtls_ssl_conf_alpn_protocols</a>( &amp;conf, alpn_list ) ) != 0 )</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;        {</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ssl_conf_alpn_protocols returned %d\n\n&quot;</span>, ret );</div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;        }</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;    <a class="code" href="ssl_8h.html#a469cd1c64bbba4be22347bf8874a017e" title="Set the random number generator callback. ">mbedtls_ssl_conf_rng</a>( &amp;conf, <a class="code" href="ctr__drbg_8h.html#af6e4dd295ae790a33128562dd01c79ab" title="CTR_DRBG generate random. ">mbedtls_ctr_drbg_random</a>, &amp;ctr_drbg );</div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;    <a class="code" href="ssl_8h.html#ab15dcbe7c7fe2a5c118e7c486c07c921" title="Set the debug callback. ">mbedtls_ssl_conf_dbg</a>( &amp;conf, my_debug, stdout );</div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;</div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_CACHE_C)</span></div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.cache_max != -1 )</div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;        <a class="code" href="ssl__cache_8h.html#abc39c23cf3f791359104d9094bd9cf6f" title="Set the cache timeout (Default: MBEDTLS_SSL_CACHE_DEFAULT_MAX_ENTRIES (50)) ">mbedtls_ssl_cache_set_max_entries</a>( &amp;cache, opt.cache_max );</div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;    <span class="keywordflow">if</span>( opt.cache_timeout != -1 )</div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;        <a class="code" href="ssl__cache_8h.html#aa3468c4ebd9484227436014db30b8f5f" title="Set the cache timeout (Default: MBEDTLS_SSL_CACHE_DEFAULT_TIMEOUT (1 day)) ">mbedtls_ssl_cache_set_timeout</a>( &amp;cache, opt.cache_timeout );</div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;</div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;    <a class="code" href="ssl_8h.html#a9a69464288d80b3904bc7540bd52aab0" title="Set the session cache callbacks (server-side only) If not set, no session resuming is done (except if...">mbedtls_ssl_conf_session_cache</a>( &amp;conf, &amp;cache,</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;                                   <a class="code" href="ssl__cache_8h.html#af0ab0006ecbbec9405be5566ac16c4b3" title="Cache get callback implementation (Thread-safe if MBEDTLS_THREADING_C is enabled) ...">mbedtls_ssl_cache_get</a>,</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;                                   <a class="code" href="ssl__cache_8h.html#a896a81cf3107ba7464e6273970c2c1eb" title="Cache set callback implementation (Thread-safe if MBEDTLS_THREADING_C is enabled) ...">mbedtls_ssl_cache_set</a> );</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_SESSION_TICKETS)</span></div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.tickets == MBEDTLS_SSL_SESSION_TICKETS_ENABLED )</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;    {</div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;        <span class="keywordflow">if</span>( ( ret = <a class="code" href="ssl__ticket_8h.html#a334f40042825a33295d0843374e1785a" title="Prepare context to be actually used. ">mbedtls_ssl_ticket_setup</a>( &amp;ticket_ctx,</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;                        <a class="code" href="ctr__drbg_8h.html#af6e4dd295ae790a33128562dd01c79ab" title="CTR_DRBG generate random. ">mbedtls_ctr_drbg_random</a>, &amp;ctr_drbg,</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;                        MBEDTLS_CIPHER_AES_256_GCM,</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;                        opt.ticket_timeout ) ) != 0 )</div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;        {</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ssl_ticket_setup returned %d\n\n&quot;</span>, ret );</div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;        }</div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;</div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;        <a class="code" href="ssl_8h.html#a73f028424df0b3a3b3360df0768df992" title="Configure SSL session ticket callbacks (server only). (Default: none.) ">mbedtls_ssl_conf_session_tickets_cb</a>( &amp;conf,</div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;                <a class="code" href="ssl__ticket_8h.html#a888e1b0900b517559ba5e89fb0843e0e" title="Implementation of the ticket write callback. ">mbedtls_ssl_ticket_write</a>,</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;                <a class="code" href="ssl__ticket_8h.html#ab8231bccc4f614d1995abd5984ffcdd8" title="Implementation of the ticket parse callback. ">mbedtls_ssl_ticket_parse</a>,</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;                &amp;ticket_ctx );</div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;    }</div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_PROTO_DTLS)</span></div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.transport == <a class="code" href="ssl_8h.html#ac00527bc4661e5d7f2df5e7e96a6a896">MBEDTLS_SSL_TRANSPORT_DATAGRAM</a> )</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;    {</div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_COOKIE_C)</span></div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>( opt.cookies &gt; 0 )</div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;        {</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;            <span class="keywordflow">if</span>( ( ret = <a class="code" href="ssl__cookie_8h.html#ac81843a6bd31b31765639b65329d6b69" title="Setup cookie context (generate keys) ">mbedtls_ssl_cookie_setup</a>( &amp;cookie_ctx,</div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;                                          <a class="code" href="ctr__drbg_8h.html#af6e4dd295ae790a33128562dd01c79ab" title="CTR_DRBG generate random. ">mbedtls_ctr_drbg_random</a>, &amp;ctr_drbg ) ) != 0 )</div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;            {</div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;                mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ssl_cookie_setup returned %d\n\n&quot;</span>, ret );</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;                <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;            }</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;</div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;            <a class="code" href="ssl_8h.html#a5865631bc70b4511c25f558d5221fd65" title="Register callbacks for DTLS cookies (Server only. DTLS only.) ">mbedtls_ssl_conf_dtls_cookies</a>( &amp;conf, <a class="code" href="ssl__cookie_8h.html#a132e60f12cd3465264d283042cabe6d2" title="Generate cookie, see mbedtls_ssl_cookie_write_t. ">mbedtls_ssl_cookie_write</a>, <a class="code" href="ssl__cookie_8h.html#ac83489027c04984e12f89b1b29eac27b" title="Verify cookie, see mbedtls_ssl_cookie_write_t. ">mbedtls_ssl_cookie_check</a>,</div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;                                       &amp;cookie_ctx );</div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;        }</div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_SSL_COOKIE_C */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_SSL_DTLS_HELLO_VERIFY)</span></div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>( opt.cookies == 0 )</div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;        {</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;            <a class="code" href="ssl_8h.html#a5865631bc70b4511c25f558d5221fd65" title="Register callbacks for DTLS cookies (Server only. DTLS only.) ">mbedtls_ssl_conf_dtls_cookies</a>( &amp;conf, NULL, NULL, NULL );</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;        }</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_SSL_DTLS_HELLO_VERIFY */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;<span class="preprocessor"></span>        {</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;            ; <span class="comment">/* Nothing to do */</span></div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;        }</div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;</div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_DTLS_ANTI_REPLAY)</span></div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>( opt.anti_replay != DFL_ANTI_REPLAY )</div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;            <a class="code" href="ssl_8h.html#a46d919254eafef2ae642fb692c5e560a" title="Enable or disable anti-replay protection for DTLS. (DTLS only, no effect on TLS.) Default: enabled...">mbedtls_ssl_conf_dtls_anti_replay</a>( &amp;conf, opt.<a class="code" href="structmbedtls__ssl__config.html#af636d34975cc5ced1aa32cb424a37c67">anti_replay</a> );</div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_DTLS_BADMAC_LIMIT)</span></div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>( opt.badmac_limit != DFL_BADMAC_LIMIT )</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;            <a class="code" href="ssl_8h.html#a9baa37a4b839319d00d8b43c8d266719" title="Set a limit on the number of records with a bad MAC before terminating the connection. (DTLS only, no effect on TLS.) Default: 0 (disabled). ">mbedtls_ssl_conf_dtls_badmac_limit</a>( &amp;conf, opt.<a class="code" href="structmbedtls__ssl__config.html#ab61653cfcc80cc9d0d902705212c6e4e">badmac_limit</a> );</div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;<span class="preprocessor"></span>    }</div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_SSL_PROTO_DTLS */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;    <span class="keywordflow">if</span>( opt.force_ciphersuite[0] != DFL_FORCE_CIPHER )</div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;        <a class="code" href="ssl_8h.html#ac8e4df37cadda8f743ed45501a51fec1" title="Set the list of allowed ciphersuites and the preference order. First in the list has the highest pref...">mbedtls_ssl_conf_ciphersuites</a>( &amp;conf, opt.force_ciphersuite );</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_ARC4_C)</span></div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.arc4 != DFL_ARC4 )</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;        <a class="code" href="ssl_8h.html#a9e904913a122bd7cb13260217e4cc868" title="Disable or enable support for RC4 (Default: MBEDTLS_SSL_ARC4_DISABLED) ">mbedtls_ssl_conf_arc4_support</a>( &amp;conf, opt.arc4 );</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;    <span class="keywordflow">if</span>( opt.version_suites != NULL )</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;    {</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;        <a class="code" href="ssl_8h.html#aa597f5461c48ee6014397c926916e6ae" title="Set the list of allowed ciphersuites and the preference order for a specific version of the protocol...">mbedtls_ssl_conf_ciphersuites_for_version</a>( &amp;conf, version_suites[0],</div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;                                          MBEDTLS_SSL_MAJOR_VERSION_3,</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;                                          <a class="code" href="ssl_8h.html#a29f89cb1c3fa78a8c57f683495feff15">MBEDTLS_SSL_MINOR_VERSION_0</a> );</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;        <a class="code" href="ssl_8h.html#aa597f5461c48ee6014397c926916e6ae" title="Set the list of allowed ciphersuites and the preference order for a specific version of the protocol...">mbedtls_ssl_conf_ciphersuites_for_version</a>( &amp;conf, version_suites[1],</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;                                          MBEDTLS_SSL_MAJOR_VERSION_3,</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;                                          <a class="code" href="ssl_8h.html#a364e4bfbd4f909a2aa7ac5eb31c6b1b2">MBEDTLS_SSL_MINOR_VERSION_1</a> );</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;        <a class="code" href="ssl_8h.html#aa597f5461c48ee6014397c926916e6ae" title="Set the list of allowed ciphersuites and the preference order for a specific version of the protocol...">mbedtls_ssl_conf_ciphersuites_for_version</a>( &amp;conf, version_suites[2],</div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;                                          MBEDTLS_SSL_MAJOR_VERSION_3,</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;                                          <a class="code" href="ssl_8h.html#a9fe59361b834e334b80efacb10f8e33a">MBEDTLS_SSL_MINOR_VERSION_2</a> );</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;        <a class="code" href="ssl_8h.html#aa597f5461c48ee6014397c926916e6ae" title="Set the list of allowed ciphersuites and the preference order for a specific version of the protocol...">mbedtls_ssl_conf_ciphersuites_for_version</a>( &amp;conf, version_suites[3],</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;                                          MBEDTLS_SSL_MAJOR_VERSION_3,</div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;                                          <a class="code" href="ssl_8h.html#a3c5a90b4b4aded2190f31f7d4c670cb4">MBEDTLS_SSL_MINOR_VERSION_3</a> );</div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;    }</div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;</div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;    <span class="keywordflow">if</span>( opt.allow_legacy != DFL_ALLOW_LEGACY )</div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;        <a class="code" href="ssl_8h.html#a193c7bf368780f485e20170c807709e5" title="Prevent or allow legacy renegotiation. (Default: MBEDTLS_SSL_LEGACY_NO_RENEGOTIATION) ...">mbedtls_ssl_conf_legacy_renegotiation</a>( &amp;conf, opt.allow_legacy );</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_RENEGOTIATION)</span></div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;<span class="preprocessor"></span>    <a class="code" href="ssl_8h.html#aad4f50fc1c0a018fd5eb18fd9621d0d3" title="Enable / Disable renegotiation support for connection when initiated by peer (Default: MBEDTLS_SSL_RE...">mbedtls_ssl_conf_renegotiation</a>( &amp;conf, opt.renegotiation );</div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;</div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;    <span class="keywordflow">if</span>( opt.renego_delay != DFL_RENEGO_DELAY )</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;        <a class="code" href="ssl_8h.html#a2d193b15941a556baaf2cb94138d66df" title="Enforce renegotiation requests. (Default: enforced, max_records = 16) ">mbedtls_ssl_conf_renegotiation_enforced</a>( &amp;conf, opt.renego_delay );</div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;</div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;    <span class="keywordflow">if</span>( opt.renego_period != DFL_RENEGO_PERIOD )</div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;    {</div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;        renego_period[7] = opt.renego_period;</div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;        <a class="code" href="ssl_8h.html#a1785faa0640bd6190c1c17a94b408e31" title="Set record counter threshold for periodic renegotiation. (Default: 2^64 - 256.) ">mbedtls_ssl_conf_renegotiation_period</a>( &amp;conf, renego_period );</div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;    }</div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_X509_CRT_PARSE_C)</span></div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( strcmp( opt.ca_path, <span class="stringliteral">&quot;none&quot;</span> ) != 0 &amp;&amp;</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;        strcmp( opt.ca_file, <span class="stringliteral">&quot;none&quot;</span> ) != 0 )</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;    {</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;        <a class="code" href="ssl_8h.html#a85c3bb6b682ba361d13de1c0a1eb69fb" title="Set the data required to verify peer certificate. ">mbedtls_ssl_conf_ca_chain</a>( &amp;conf, &amp;cacert, NULL );</div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;    }</div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;    <span class="keywordflow">if</span>( key_cert_init )</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;        <span class="keywordflow">if</span>( ( ret = <a class="code" href="ssl_8h.html#a4e54e9ace21beb608bae36ddb81a4fb0" title="Set own certificate chain and private key. ">mbedtls_ssl_conf_own_cert</a>( &amp;conf, &amp;srvcert, &amp;pkey ) ) != 0 )</div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;        {</div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ssl_conf_own_cert returned %d\n\n&quot;</span>, ret );</div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;        }</div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;    <span class="keywordflow">if</span>( key_cert_init2 )</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;        <span class="keywordflow">if</span>( ( ret = <a class="code" href="ssl_8h.html#a4e54e9ace21beb608bae36ddb81a4fb0" title="Set own certificate chain and private key. ">mbedtls_ssl_conf_own_cert</a>( &amp;conf, &amp;srvcert2, &amp;pkey2 ) ) != 0 )</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;        {</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ssl_conf_own_cert returned %d\n\n&quot;</span>, ret );</div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;        }</div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;<span class="preprocessor">#if defined(SNI_OPTION)</span></div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.sni != NULL )</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;        <a class="code" href="ssl_8h.html#a38ee2c1e3f232444df5ba3952d7ded33" title="Set server side ServerName TLS extension callback (optional, server-side only). ">mbedtls_ssl_conf_sni</a>( &amp;conf, sni_callback, sni_info );</div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_KEY_EXCHANGE__SOME__PSK_ENABLED)</span></div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( strlen( opt.psk ) != 0 &amp;&amp; strlen( opt.psk_identity ) != 0 )</div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;    {</div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;        ret = <a class="code" href="ssl_8h.html#a1e185199e3ff613bdd1c8231a19e24fc" title="Set the Pre Shared Key (PSK) and the expected identity name. ">mbedtls_ssl_conf_psk</a>( &amp;conf, psk, psk_len,</div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;                           (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) opt.<a class="code" href="structmbedtls__ssl__config.html#a3ed897b829686c76876d5f2bbb43d641">psk_identity</a>,</div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;                           strlen( opt.psk_identity ) );</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;        <span class="keywordflow">if</span>( ret != 0 )</div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;        {</div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot;  failed\n  mbedtls_ssl_conf_psk returned -0x%04X\n\n&quot;</span>, - ret );</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;        }</div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;    }</div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;</div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;    <span class="keywordflow">if</span>( opt.psk_list != NULL )</div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;        <a class="code" href="ssl_8h.html#a1b804626a236e493316c58b048ab5937" title="Set the PSK callback (server-side only). ">mbedtls_ssl_conf_psk_cb</a>( &amp;conf, psk_callback, psk_info );</div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_DHM_C)</span></div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;<span class="preprocessor"></span>    <span class="comment">/*</span></div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;<span class="comment">     * Use different group than default DHM group</span></div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_FS_IO)</span></div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.dhm_file != NULL )</div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;        ret = <a class="code" href="ssl_8h.html#aec6d67681da3a0d5cb259137af176d56" title="Set the Diffie-Hellman public P and G values, read from existing context (server-side only) ...">mbedtls_ssl_conf_dh_param_ctx</a>( &amp;conf, &amp;dhm );</div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( ret != 0 )</div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;    {</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot;  failed\n  mbedtls_ssl_conf_dh_param returned -0x%04X\n\n&quot;</span>, - ret );</div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;    }</div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;    <span class="keywordflow">if</span>( opt.min_version != DFL_MIN_VERSION )</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;        <a class="code" href="ssl_8h.html#a0eade5c83cc08001672061c5925caaaa" title="Set the minimum accepted SSL/TLS protocol version (Default: TLS 1.0) ">mbedtls_ssl_conf_min_version</a>( &amp;conf, MBEDTLS_SSL_MAJOR_VERSION_3, opt.min_version );</div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;</div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;    <span class="keywordflow">if</span>( opt.max_version != DFL_MIN_VERSION )</div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;        <a class="code" href="ssl_8h.html#afc1a81e3fcbea3045b41ce739a47f54e" title="Set the maximum supported version sent from the client side and/or accepted at the server side (Defau...">mbedtls_ssl_conf_max_version</a>( &amp;conf, MBEDTLS_SSL_MAJOR_VERSION_3, opt.max_version );</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;</div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    <span class="keywordflow">if</span>( ( ret = <a class="code" href="ssl_8h.html#af79cb539a0ee6ac20cf9c574f4c3b343" title="Set up an SSL context for use. ">mbedtls_ssl_setup</a>( &amp;ssl, &amp;conf ) ) != 0 )</div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;    {</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ssl_setup returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;    }</div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;</div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;    <span class="keywordflow">if</span>( opt.nbio == 2 )</div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;        <a class="code" href="ssl_8h.html#a143c1f887e1a2ca33b684ba4cf6c0543" title="Set the underlying BIO callbacks for write, read and read-with-timeout. ">mbedtls_ssl_set_bio</a>( &amp;ssl, &amp;client_fd, my_send, my_recv, NULL );</div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;        <a class="code" href="ssl_8h.html#a143c1f887e1a2ca33b684ba4cf6c0543" title="Set the underlying BIO callbacks for write, read and read-with-timeout. ">mbedtls_ssl_set_bio</a>( &amp;ssl, &amp;client_fd, <a class="code" href="net_8h.html#a4841afd0e14f1fd44b82c3a850961ab7" title="Write at most &#39;len&#39; characters. If no error occurs, the actual amount read is returned. ">mbedtls_net_send</a>, <a class="code" href="net_8h.html#a03af351ec420bbeb5e91357abcfb3663" title="Read at most &#39;len&#39; characters. If no error occurs, the actual amount read is returned. ">mbedtls_net_recv</a>,</div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;                             opt.nbio == 0 ? <a class="code" href="net_8h.html#a67810154d2328a80b146155d8cdecfd9" title="Read at most &#39;len&#39; characters, blocking for at most &#39;timeout&#39; seconds. If no error occurs...">mbedtls_net_recv_timeout</a> : NULL );</div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;</div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_TIMING_C)</span></div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;<span class="preprocessor"></span>    <a class="code" href="ssl_8h.html#a969d40f929829829e5196c6829220da7" title="Set the timer callbacks (Mandatory for DTLS.) ">mbedtls_ssl_set_timer_cb</a>( &amp;ssl, &amp;timer, <a class="code" href="timing_8h.html#aeb3497ab85adabf7db89d81c34e2ef92" title="Set a pair of delays to watch (See mbedtls_timing_get_delay().) ">mbedtls_timing_set_delay</a>,</div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;                                            <a class="code" href="timing_8h.html#afb1705e8c4227b0ec03089aa7fc54d9b" title="Get the status of delays (Memory helper: number of delays passed.) ">mbedtls_timing_get_delay</a> );</div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot; ok\n&quot;</span> );</div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;</div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;reset:</div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;<span class="preprocessor">#if !defined(_WIN32)</span></div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( received_sigterm )</div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;    {</div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; interrupted by SIGTERM\n&quot;</span> );</div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;        ret = 0;</div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;    }</div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;<span class="preprocessor">#ifdef MBEDTLS_ERROR_C</span></div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( ret != 0 )</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;    {</div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;        <span class="keywordtype">char</span> error_buf[100];</div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;        <a class="code" href="error_8h.html#a8c41c149b77a4807115b19c2af858558" title="Translate a mbed TLS error code into a string representation, Result is truncated if necessary and al...">mbedtls_strerror</a>( ret, error_buf, 100 );</div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;        mbedtls_printf(<span class="stringliteral">&quot;Last error was: %d - %s\n\n&quot;</span>, ret, error_buf );</div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;    }</div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;    <a class="code" href="net_8h.html#a77c35cb3f4b9fe6035d1d3742f3b4a24" title="Gracefully shutdown the connection and free associated data. ">mbedtls_net_free</a>( &amp;client_fd );</div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;</div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;    <a class="code" href="ssl_8h.html#a21432367cbce428f10dcb62d9456fa7e" title="Reset an already initialized SSL context for re-use while retaining application-set variables...">mbedtls_ssl_session_reset</a>( &amp;ssl );</div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;</div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;<span class="comment">     * 3. Wait until a client connects</span></div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot;  . Waiting for a remote connection ...&quot;</span> );</div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;    fflush( stdout );</div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;</div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;    <span class="keywordflow">if</span>( ( ret = <a class="code" href="net_8h.html#a2f862b9086f3466593d5cf399b2c98c6" title="Accept a connection from a remote client. ">mbedtls_net_accept</a>( &amp;listen_fd, &amp;client_fd,</div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;                    client_ip, <span class="keyword">sizeof</span>( client_ip ), &amp;cliip_len ) ) != 0 )</div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;    {</div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;<span class="preprocessor">#if !defined(_WIN32)</span></div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>( received_sigterm )</div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;        {</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; interrupted by signal\n&quot;</span> );</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;            ret = 0;</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;        }</div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_net_accept returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;    }</div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;</div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;    <span class="keywordflow">if</span>( opt.nbio &gt; 0 )</div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;        ret = <a class="code" href="net_8h.html#a2ee4acdc24ef78c9acf5068a423b8c30" title="Set the socket non-blocking. ">mbedtls_net_set_nonblock</a>( &amp;client_fd );</div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;        ret = <a class="code" href="net_8h.html#aeea4e6fd5ad3167bf8563e61f6f75963" title="Set the socket blocking. ">mbedtls_net_set_block</a>( &amp;client_fd );</div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;    <span class="keywordflow">if</span>( ret != 0 )</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;    {</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! net_set_(non)block() returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;        <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;    }</div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;</div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;    <a class="code" href="ssl_8h.html#a0d925033b3a46a48b3f8acc1d743af90" title="Set the timeout period for mbedtls_ssl_read() (Default: no timeout.) ">mbedtls_ssl_conf_read_timeout</a>( &amp;conf, opt.<a class="code" href="structmbedtls__ssl__config.html#a8f32ca22ea20b3848176d78390c13153">read_timeout</a> );</div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;</div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_DTLS_HELLO_VERIFY)</span></div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.transport == <a class="code" href="ssl_8h.html#ac00527bc4661e5d7f2df5e7e96a6a896">MBEDTLS_SSL_TRANSPORT_DATAGRAM</a> )</div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;    {</div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;        <span class="keywordflow">if</span>( ( ret = <a class="code" href="ssl_8h.html#a15fab95c13a898f32fa69ff2065c1051" title="Set client&#39;s transport-level identification info. (Server only. DTLS only.) ">mbedtls_ssl_set_client_transport_id</a>( &amp;ssl,</div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;                        client_ip, cliip_len ) ) != 0 )</div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;        {</div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! &quot;</span></div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;                    <span class="stringliteral">&quot;mbedtls_ssl_set_client_transport_id() returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;            <span class="keywordflow">goto</span> exit;</div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;        }</div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;    }</div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_SSL_DTLS_HELLO_VERIFY */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot; ok\n&quot;</span> );</div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;</div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;<span class="comment">     * 4. Handshake</span></div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot;  . Performing the SSL/TLS handshake...&quot;</span> );</div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;    fflush( stdout );</div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;</div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;    <span class="keywordflow">do</span> ret = <a class="code" href="ssl_8h.html#a4a37e497cd08c896870a42b1b618186e" title="Perform the SSL handshake. ">mbedtls_ssl_handshake</a>( &amp;ssl );</div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;    <span class="keywordflow">while</span>( ret == <a class="code" href="ssl_8h.html#a67a1e093cf042831aa60bb567915b560">MBEDTLS_ERR_SSL_WANT_READ</a> ||</div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;           ret == <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a> );</div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;</div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;    <span class="keywordflow">if</span>( ret == <a class="code" href="ssl_8h.html#a18d6936a834082004d1b1d16fe0007a2">MBEDTLS_ERR_SSL_HELLO_VERIFY_REQUIRED</a> )</div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;    {</div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; hello verification requested\n&quot;</span> );</div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;        ret = 0;</div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;        <span class="keywordflow">goto</span> reset;</div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;    }</div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ret != 0 )</div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;    {</div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ssl_handshake returned -0x%x\n\n&quot;</span>, -ret );</div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;</div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_X509_CRT_PARSE_C)</span></div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span>( ret == <a class="code" href="group__x509__module.html#gaba46df0041dcf48fa9d164d28cf3a154">MBEDTLS_ERR_X509_CERT_VERIFY_FAILED</a> )</div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;        {</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;            <span class="keywordtype">char</span> vrfy_buf[512];</div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;            uint32_t flags = <a class="code" href="ssl_8h.html#a516064f1468d459159ef7cd6c496a026" title="Return the result of the certificate verification. ">mbedtls_ssl_get_verify_result</a>( &amp;ssl );</div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;</div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;            <a class="code" href="group__x509__module.html#gae88f1d8e6696eb2beeffe0a708219e6b" title="Returns an informational string about the verification status of a certificate. ">mbedtls_x509_crt_verify_info</a>( vrfy_buf, <span class="keyword">sizeof</span>( vrfy_buf ), <span class="stringliteral">&quot;  ! &quot;</span>, flags );</div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;</div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot;%s\n&quot;</span>, vrfy_buf );</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;        }</div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;        <span class="keywordflow">goto</span> reset;</div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;    }</div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;    <span class="keywordflow">else</span> <span class="comment">/* ret == 0 */</span></div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;    {</div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; ok\n    [ Protocol is %s ]\n    [ Ciphersuite is %s ]\n&quot;</span>,</div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;                <a class="code" href="ssl_8h.html#a1ee2e52fe2ae9620af84df97a0347ce3" title="Return the current SSL version (SSLv3/TLSv1/etc) ">mbedtls_ssl_get_version</a>( &amp;ssl ), <a class="code" href="ssl_8h.html#a18739598df499461369020b8ea6fff1c" title="Return the name of the current ciphersuite. ">mbedtls_ssl_get_ciphersuite</a>( &amp;ssl ) );</div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;    }</div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;</div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;    <span class="keywordflow">if</span>( ( ret = <a class="code" href="ssl_8h.html#a935f3ebfb31f988e24a8bf9bcb0fd26b" title="Return the (maximum) number of bytes added by the record layer: header + encryption/MAC overhead (inc...">mbedtls_ssl_get_record_expansion</a>( &amp;ssl ) ) &gt;= 0 )</div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot;    [ Record expansion is %d ]\n&quot;</span>, ret );</div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot;    [ Record expansion is unknown (compression) ]\n&quot;</span> );</div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;</div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_ALPN)</span></div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.alpn_string != NULL )</div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;    {</div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span> *alp = <a class="code" href="ssl_8h.html#ad1ab606db1a9307b4aacccdcd1d1a6ef" title="Get the name of the negotiated Application Layer Protocol. This function should be called after the h...">mbedtls_ssl_get_alpn_protocol</a>( &amp;ssl );</div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot;    [ Application Layer Protocol is %s ]\n&quot;</span>,</div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;                alp ? alp : <span class="stringliteral">&quot;(none)&quot;</span> );</div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;    }</div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_X509_CRT_PARSE_C)</span></div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;<span class="preprocessor"></span>    <span class="comment">/*</span></div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;<span class="comment">     * 5. Verify the server certificate</span></div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot;  . Verifying peer X.509 certificate...&quot;</span> );</div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;</div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;    <span class="keywordflow">if</span>( ( flags = <a class="code" href="ssl_8h.html#a516064f1468d459159ef7cd6c496a026" title="Return the result of the certificate verification. ">mbedtls_ssl_get_verify_result</a>( &amp;ssl ) ) != 0 )</div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;    {</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;        <span class="keywordtype">char</span> vrfy_buf[512];</div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;</div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; failed\n&quot;</span> );</div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;</div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;        <a class="code" href="group__x509__module.html#gae88f1d8e6696eb2beeffe0a708219e6b" title="Returns an informational string about the verification status of a certificate. ">mbedtls_x509_crt_verify_info</a>( vrfy_buf, <span class="keyword">sizeof</span>( vrfy_buf ), <span class="stringliteral">&quot;  ! &quot;</span>, flags );</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;</div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot;%s\n&quot;</span>, vrfy_buf );</div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;    }</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; ok\n&quot;</span> );</div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;</div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;    <span class="keywordflow">if</span>( <a class="code" href="ssl_8h.html#aa7ab0ac8d8341063a0f815ee99337831" title="Return the peer certificate from the current connection. ">mbedtls_ssl_get_peer_cert</a>( &amp;ssl ) != NULL )</div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;    {</div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;        <span class="keywordtype">char</span> crt_buf[512];</div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;</div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot;  . Peer certificate information    ...\n&quot;</span> );</div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;        <a class="code" href="group__x509__module.html#gabaf30f2269fc3b6608b25871f9d09da6" title="Returns an informational string about the certificate. ">mbedtls_x509_crt_info</a>( crt_buf, <span class="keyword">sizeof</span>( crt_buf ), <span class="stringliteral">&quot;      &quot;</span>,</div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;                       <a class="code" href="ssl_8h.html#aa7ab0ac8d8341063a0f815ee99337831" title="Return the peer certificate from the current connection. ">mbedtls_ssl_get_peer_cert</a>( &amp;ssl ) );</div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot;%s\n&quot;</span>, crt_buf );</div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;    }</div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_X509_CRT_PARSE_C */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;    <span class="keywordflow">if</span>( opt.exchanges == 0 )</div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;        <span class="keywordflow">goto</span> close_notify;</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;</div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;    exchanges_left = opt.exchanges;</div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;data_exchange:</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;<span class="comment">     * 6. Read the HTTP Request</span></div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot;  &lt; Read from client:&quot;</span> );</div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;    fflush( stdout );</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;</div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;<span class="comment">     * TLS and DTLS need different reading styles (stream vs datagram)</span></div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;    <span class="keywordflow">if</span>( opt.transport == <a class="code" href="ssl_8h.html#acf690cf4772ff3e2df4b8295275e6fc7">MBEDTLS_SSL_TRANSPORT_STREAM</a> )</div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;    {</div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;        <span class="keywordflow">do</span></div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;        {</div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;            <span class="keywordtype">int</span> terminated = 0;</div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;            len = <span class="keyword">sizeof</span>( buf ) - 1;</div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;            memset( buf, 0, <span class="keyword">sizeof</span>( buf ) );</div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;            ret = <a class="code" href="ssl_8h.html#aa2c29eeb1deaf5ad9f01a7515006ede5" title="Read at most &#39;len&#39; application data bytes. ">mbedtls_ssl_read</a>( &amp;ssl, buf, len );</div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;</div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;            <span class="keywordflow">if</span>( ret == <a class="code" href="ssl_8h.html#a67a1e093cf042831aa60bb567915b560">MBEDTLS_ERR_SSL_WANT_READ</a> ||</div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;                ret == <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a> )</div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;            <span class="keywordflow">if</span>( ret &lt;= 0 )</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;            {</div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;                <span class="keywordflow">switch</span>( ret )</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;                {</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="ssl_8h.html#ac5e16e4c94a7e4ba0cf6b95c4547ddb1">MBEDTLS_ERR_SSL_PEER_CLOSE_NOTIFY</a>:</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;                        mbedtls_printf( <span class="stringliteral">&quot; connection was closed gracefully\n&quot;</span> );</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;                        <span class="keywordflow">goto</span> close_notify;</div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;                    <span class="keywordflow">case</span> 0:</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="net_8h.html#a1793f099e5c010750c7a07bf259898d9">MBEDTLS_ERR_NET_CONN_RESET</a>:</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;                        mbedtls_printf( <span class="stringliteral">&quot; connection was reset by peer\n&quot;</span> );</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;                        ret = <a class="code" href="net_8h.html#a1793f099e5c010750c7a07bf259898d9">MBEDTLS_ERR_NET_CONN_RESET</a>;</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;                        <span class="keywordflow">goto</span> reset;</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;                    <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;                        mbedtls_printf( <span class="stringliteral">&quot; mbedtls_ssl_read returned -0x%x\n&quot;</span>, -ret );</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;                        <span class="keywordflow">goto</span> reset;</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;                }</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;            }</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;</div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;            <span class="keywordflow">if</span>( <a class="code" href="ssl_8h.html#ad43142085f3182e9b0dc967ec582032b" title="Return the number of data bytes available to read. ">mbedtls_ssl_get_bytes_avail</a>( &amp;ssl ) == 0 )</div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;            {</div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;                len = ret;</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;                buf[len] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;                mbedtls_printf( <span class="stringliteral">&quot; %d bytes read\n\n%s\n&quot;</span>, len, (<span class="keywordtype">char</span> *) buf );</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;                <span class="comment">/* End of message should be detected according to the syntax of the</span></div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;<span class="comment">                 * application protocol (eg HTTP), just use a dummy test here. */</span></div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;                <span class="keywordflow">if</span>( buf[len - 1] == <span class="charliteral">&#39;\n&#39;</span> )</div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;                    terminated = 1;</div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;            }</div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;            {</div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;                <span class="keywordtype">int</span> extra_len, ori_len;</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *larger_buf;</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;                ori_len = ret;</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;                extra_len = (int) <a class="code" href="ssl_8h.html#ad43142085f3182e9b0dc967ec582032b" title="Return the number of data bytes available to read. ">mbedtls_ssl_get_bytes_avail</a>( &amp;ssl );</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;                larger_buf = mbedtls_calloc( 1, ori_len + extra_len + 1 );</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;                <span class="keywordflow">if</span>( larger_buf == NULL )</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;                {</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;                    mbedtls_printf( <span class="stringliteral">&quot;  ! memory allocation failed\n&quot;</span> );</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;                    ret = 1;</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;                    <span class="keywordflow">goto</span> reset;</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;                }</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;                memset( larger_buf, 0, ori_len + extra_len );</div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;                memcpy( larger_buf, buf, ori_len );</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;</div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;                <span class="comment">/* This read should never fail and get the whole cached data */</span></div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;                ret = <a class="code" href="ssl_8h.html#aa2c29eeb1deaf5ad9f01a7515006ede5" title="Read at most &#39;len&#39; application data bytes. ">mbedtls_ssl_read</a>( &amp;ssl, larger_buf + ori_len, extra_len );</div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;                <span class="keywordflow">if</span>( ret != extra_len ||</div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;                    <a class="code" href="ssl_8h.html#ad43142085f3182e9b0dc967ec582032b" title="Return the number of data bytes available to read. ">mbedtls_ssl_get_bytes_avail</a>( &amp;ssl ) != 0 )</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;                {</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;                    mbedtls_printf( <span class="stringliteral">&quot;  ! mbedtls_ssl_read failed on cached data\n&quot;</span> );</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;                    ret = 1;</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;                    <span class="keywordflow">goto</span> reset;</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;                }</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;</div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;                larger_buf[ori_len + extra_len] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;                mbedtls_printf( <span class="stringliteral">&quot; %u bytes read (%u + %u)\n\n%s\n&quot;</span>,</div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;                        ori_len + extra_len, ori_len, extra_len,</div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;                        (<span class="keywordtype">char</span> *) larger_buf );</div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;</div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;                <span class="comment">/* End of message should be detected according to the syntax of the</span></div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;<span class="comment">                 * application protocol (eg HTTP), just use a dummy test here. */</span></div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;                <span class="keywordflow">if</span>( larger_buf[ori_len + extra_len - 1] == <span class="charliteral">&#39;\n&#39;</span> )</div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;                    terminated = 1;</div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;                mbedtls_free( larger_buf );</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;            }</div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;</div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;            <span class="keywordflow">if</span>( terminated )</div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;            {</div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;                ret = 0;</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;            }</div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;        }</div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;        <span class="keywordflow">while</span>( 1 );</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;    }</div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;    <span class="keywordflow">else</span> <span class="comment">/* Not stream, so datagram */</span></div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;    {</div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;        len = <span class="keyword">sizeof</span>( buf ) - 1;</div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;        memset( buf, 0, <span class="keyword">sizeof</span>( buf ) );</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;</div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;        <span class="keywordflow">do</span> ret = <a class="code" href="ssl_8h.html#aa2c29eeb1deaf5ad9f01a7515006ede5" title="Read at most &#39;len&#39; application data bytes. ">mbedtls_ssl_read</a>( &amp;ssl, buf, len );</div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;        <span class="keywordflow">while</span>( ret == <a class="code" href="ssl_8h.html#a67a1e093cf042831aa60bb567915b560">MBEDTLS_ERR_SSL_WANT_READ</a> ||</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;               ret == <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a> );</div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;</div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;        <span class="keywordflow">if</span>( ret &lt;= 0 )</div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;        {</div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;            <span class="keywordflow">switch</span>( ret )</div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;            {</div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="ssl_8h.html#ac5e16e4c94a7e4ba0cf6b95c4547ddb1">MBEDTLS_ERR_SSL_PEER_CLOSE_NOTIFY</a>:</div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;                    mbedtls_printf( <span class="stringliteral">&quot; connection was closed gracefully\n&quot;</span> );</div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;                    ret = 0;</div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;                    <span class="keywordflow">goto</span> close_notify;</div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;                <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;                    mbedtls_printf( <span class="stringliteral">&quot; mbedtls_ssl_read returned -0x%x\n&quot;</span>, -ret );</div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;                    <span class="keywordflow">goto</span> reset;</div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;            }</div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;        }</div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;        len = ret;</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;        buf[len] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; %d bytes read\n\n%s&quot;</span>, len, (<span class="keywordtype">char</span> *) buf );</div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;        ret = 0;</div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;    }</div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;</div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;<span class="comment">     * 7a. Request renegotiation while client is waiting for input from us.</span></div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;<span class="comment">     * (only on the first exchange, to be able to test retransmission)</span></div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_RENEGOTIATION)</span></div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( opt.renegotiate &amp;&amp; exchanges_left == opt.exchanges )</div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;    {</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot;  . Requestion renegotiation...&quot;</span> );</div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;        fflush( stdout );</div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;</div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;        <span class="keywordflow">while</span>( ( ret = <a class="code" href="ssl_8h.html#a49b7a27a616495d5f0a4fabc3f550dbb" title="Initiate an SSL renegotiation on the running connection. Client: perform the renegotiation right now...">mbedtls_ssl_renegotiate</a>( &amp;ssl ) ) != 0 )</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;        {</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;            <span class="keywordflow">if</span>( ret != <a class="code" href="ssl_8h.html#a67a1e093cf042831aa60bb567915b560">MBEDTLS_ERR_SSL_WANT_READ</a> &amp;&amp;</div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;                ret != <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a> )</div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;            {</div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;                mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ssl_renegotiate returned %d\n\n&quot;</span>, ret );</div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;                <span class="keywordflow">goto</span> reset;</div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;            }</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;        }</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;        mbedtls_printf( <span class="stringliteral">&quot; ok\n&quot;</span> );</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;    }</div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_SSL_RENEGOTIATION */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;<span class="comment">     * 7. Write the 200 Response</span></div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot;  &gt; Write to client:&quot;</span> );</div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;    fflush( stdout );</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;</div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;    len = sprintf( (<span class="keywordtype">char</span> *) buf, HTTP_RESPONSE,</div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;                   <a class="code" href="ssl_8h.html#a18739598df499461369020b8ea6fff1c" title="Return the name of the current ciphersuite. ">mbedtls_ssl_get_ciphersuite</a>( &amp;ssl ) );</div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;</div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;    <span class="keywordflow">if</span>( opt.transport == <a class="code" href="ssl_8h.html#acf690cf4772ff3e2df4b8295275e6fc7">MBEDTLS_SSL_TRANSPORT_STREAM</a> )</div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;    {</div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;        <span class="keywordflow">for</span>( written = 0, frags = 0; written &lt; len; written += ret, frags++ )</div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;        {</div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;            <span class="keywordflow">while</span>( ( ret = <a class="code" href="ssl_8h.html#a5bbda87d484de82df730758b475f32e5" title="Write exactly &#39;len&#39; application data bytes. ">mbedtls_ssl_write</a>( &amp;ssl, buf + written, len - written ) )</div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;                           &lt;= 0 )</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;            {</div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;                <span class="keywordflow">if</span>( ret == <a class="code" href="net_8h.html#a1793f099e5c010750c7a07bf259898d9">MBEDTLS_ERR_NET_CONN_RESET</a> )</div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;                {</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;                    mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! peer closed the connection\n\n&quot;</span> );</div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;                    <span class="keywordflow">goto</span> reset;</div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;                }</div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;</div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;                <span class="keywordflow">if</span>( ret != <a class="code" href="ssl_8h.html#a67a1e093cf042831aa60bb567915b560">MBEDTLS_ERR_SSL_WANT_READ</a> &amp;&amp;</div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;                    ret != <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a> )</div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;                {</div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;                    mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ssl_write returned %d\n\n&quot;</span>, ret );</div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;                    <span class="keywordflow">goto</span> reset;</div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;                }</div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;            }</div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;        }</div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;    }</div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;    <span class="keywordflow">else</span> <span class="comment">/* Not stream, so datagram */</span></div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;    {</div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;        <span class="keywordflow">do</span> ret = <a class="code" href="ssl_8h.html#a5bbda87d484de82df730758b475f32e5" title="Write exactly &#39;len&#39; application data bytes. ">mbedtls_ssl_write</a>( &amp;ssl, buf, len );</div>
<div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;        <span class="keywordflow">while</span>( ret == <a class="code" href="ssl_8h.html#a67a1e093cf042831aa60bb567915b560">MBEDTLS_ERR_SSL_WANT_READ</a> ||</div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;               ret == <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a> );</div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;</div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;        <span class="keywordflow">if</span>( ret &lt; 0 )</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;        {</div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;            mbedtls_printf( <span class="stringliteral">&quot; failed\n  ! mbedtls_ssl_write returned %d\n\n&quot;</span>, ret );</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;            <span class="keywordflow">goto</span> reset;</div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;        }</div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;</div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;        frags = 1;</div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;        written = ret;</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;    }</div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;</div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;    buf[written] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot; %d bytes written in %d fragments\n\n%s\n&quot;</span>, written, frags, (<span class="keywordtype">char</span> *) buf );</div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;    ret = 0;</div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;</div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;<span class="comment">     * 7b. Continue doing data exchanges?</span></div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;    <span class="keywordflow">if</span>( --exchanges_left &gt; 0 )</div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;        <span class="keywordflow">goto</span> data_exchange;</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;</div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;<span class="comment">     * 8. Done, cleanly close the connection</span></div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;close_notify:</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot;  . Closing the connection...&quot;</span> );</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;    <span class="comment">/* No error checking, the connection might be closed already */</span></div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;    <span class="keywordflow">do</span> ret = <a class="code" href="ssl_8h.html#ac2c1b17128ead2df3082e27b603deb4c" title="Notify the peer that the connection is being closed. ">mbedtls_ssl_close_notify</a>( &amp;ssl );</div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;    <span class="keywordflow">while</span>( ret == <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a> );</div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;    ret = 0;</div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot; done\n&quot;</span> );</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;</div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;    <span class="keywordflow">goto</span> reset;</div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;</div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;<span class="comment">     * Cleanup and exit</span></div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;exit:</div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;<span class="preprocessor">#ifdef MBEDTLS_ERROR_C</span></div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span>( ret != 0 )</div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;    {</div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;        <span class="keywordtype">char</span> error_buf[100];</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;        <a class="code" href="error_8h.html#a8c41c149b77a4807115b19c2af858558" title="Translate a mbed TLS error code into a string representation, Result is truncated if necessary and al...">mbedtls_strerror</a>( ret, error_buf, 100 );</div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;        mbedtls_printf(<span class="stringliteral">&quot;Last error was: -0x%X - %s\n\n&quot;</span>, -ret, error_buf );</div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;    }</div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot;  . Cleaning up...&quot;</span> );</div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;    fflush( stdout );</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;</div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;    <a class="code" href="net_8h.html#a77c35cb3f4b9fe6035d1d3742f3b4a24" title="Gracefully shutdown the connection and free associated data. ">mbedtls_net_free</a>( &amp;client_fd );</div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;    <a class="code" href="net_8h.html#a77c35cb3f4b9fe6035d1d3742f3b4a24" title="Gracefully shutdown the connection and free associated data. ">mbedtls_net_free</a>( &amp;listen_fd );</div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;</div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_DHM_C) &amp;&amp; defined(MBEDTLS_FS_IO)</span></div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;<span class="preprocessor"></span>    <a class="code" href="dhm_8h.html#a092d039d88063538f67aaf9cf45d1d30" title="Free and clear the components of a DHM key. ">mbedtls_dhm_free</a>( &amp;dhm );</div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_X509_CRT_PARSE_C)</span></div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;<span class="preprocessor"></span>    <a class="code" href="group__x509__module.html#gab33c1e4e20bea7ce536119f54a113c6b" title="Unallocate all certificate data. ">mbedtls_x509_crt_free</a>( &amp;cacert );</div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;    <a class="code" href="group__x509__module.html#gab33c1e4e20bea7ce536119f54a113c6b" title="Unallocate all certificate data. ">mbedtls_x509_crt_free</a>( &amp;srvcert );</div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;    <a class="code" href="pk_8h.html#ac6a9786d96abfd73c4dff6814238feb9" title="Free a mbedtls_pk_context. ">mbedtls_pk_free</a>( &amp;pkey );</div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;    <a class="code" href="group__x509__module.html#gab33c1e4e20bea7ce536119f54a113c6b" title="Unallocate all certificate data. ">mbedtls_x509_crt_free</a>( &amp;srvcert2 );</div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;    <a class="code" href="pk_8h.html#ac6a9786d96abfd73c4dff6814238feb9" title="Free a mbedtls_pk_context. ">mbedtls_pk_free</a>( &amp;pkey2 );</div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(SNI_OPTION)</span></div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;<span class="preprocessor"></span>    sni_free( sni_info );</div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_KEY_EXCHANGE__SOME__PSK_ENABLED)</span></div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;<span class="preprocessor"></span>    psk_free( psk_info );</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_DHM_C) &amp;&amp; defined(MBEDTLS_FS_IO)</span></div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;<span class="preprocessor"></span>    <a class="code" href="dhm_8h.html#a092d039d88063538f67aaf9cf45d1d30" title="Free and clear the components of a DHM key. ">mbedtls_dhm_free</a>( &amp;dhm );</div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;    <a class="code" href="ssl_8h.html#a2dc104a181bcd11eafbbf7e6923978bc" title="Free referenced items in an SSL context and clear memory. ">mbedtls_ssl_free</a>( &amp;ssl );</div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;    <a class="code" href="ssl_8h.html#a7655f025440a6c5ccd4fc13832abb1dd" title="Free an SSL configuration context. ">mbedtls_ssl_config_free</a>( &amp;conf );</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;    <a class="code" href="ctr__drbg_8h.html#a1ea42b9eb6f6b33c82359f4c0a57ca43" title="Clear CTR_CRBG context data. ">mbedtls_ctr_drbg_free</a>( &amp;ctr_drbg );</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;    <a class="code" href="entropy_8h.html#a06778439f8a0e2daa2d3b444e06ad8dd" title="Free the data in the context. ">mbedtls_entropy_free</a>( &amp;entropy );</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;</div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_SSL_CACHE_C)</span></div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;<span class="preprocessor"></span>    <a class="code" href="ssl__cache_8h.html#a93a35f5cd109f9d698bfac659905c0d8" title="Free referenced items in a cache context and clear memory. ">mbedtls_ssl_cache_free</a>( &amp;cache );</div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_SSL_SESSION_TICKETS)</span></div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;<span class="preprocessor"></span>    <a class="code" href="ssl__ticket_8h.html#a254bccc118c66a617ba6020a2d8cc69c" title="Free a context&#39;s content and zeroize it. ">mbedtls_ssl_ticket_free</a>( &amp;ticket_ctx );</div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_SSL_COOKIE_C)</span></div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;<span class="preprocessor"></span>    <a class="code" href="ssl__cookie_8h.html#a77d57052186940783e056f5ca95bda03" title="Free cookie context. ">mbedtls_ssl_cookie_free</a>( &amp;cookie_ctx );</div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;<span class="preprocessor">#if defined(MBEDTLS_MEMORY_BUFFER_ALLOC_C)</span></div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if defined(MBEDTLS_MEMORY_DEBUG)</span></div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;<span class="preprocessor"></span>    mbedtls_memory_buffer_alloc_status();</div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;<span class="preprocessor"></span>    <a class="code" href="memory__buffer__alloc_8h.html#ae9d7316a19b72776f34ba74720a06325" title="Free the mutex for thread-safety and clear remaining memory. ">mbedtls_memory_buffer_alloc_free</a>();</div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;    mbedtls_printf( <span class="stringliteral">&quot; done.\n&quot;</span> );</div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;</div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;<span class="preprocessor">#if defined(_WIN32)</span></div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;<span class="preprocessor"></span>    mbedtls_printf( <span class="stringliteral">&quot;  + Press Enter to exit this program.\n&quot;</span> );</div>
<div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;    fflush( stdout ); getchar();</div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;    <span class="comment">// Shell can not handle large exit numbers -&gt; 1 for errors</span></div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;    <span class="keywordflow">if</span>( ret &lt; 0 )</div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;        ret = 1;</div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;</div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;    <span class="keywordflow">return</span>( ret );</div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;}</div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_BIGNUM_C &amp;&amp; MBEDTLS_ENTROPY_C &amp;&amp; MBEDTLS_SSL_TLS_C &amp;&amp;</span></div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;<span class="comment">          MBEDTLS_SSL_SRV_C &amp;&amp; MBEDTLS_NET_C &amp;&amp; MBEDTLS_RSA_C &amp;&amp;</span></div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;<span class="comment">          MBEDTLS_CTR_DRBG_C */</span><span class="preprocessor"></span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_7b0a5d1507c7f681cbfa1deb5990c6ea.html">programs</a></li><li class="navelem"><a class="el" href="dir_7bf494d822ab4a70f46c5d997dbee6df.html">ssl</a></li><li class="navelem"><b>ssl_server2.c</b></li>
    <li class="footer">Generated on Sun Aug 30 2015 15:29:51 for mbedtls by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
