<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>mbedtls: C:/dev2/luambedtls/dependencies/mbedtls/yotta/data/example-tls-client/main.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">mbedtls
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('example-tls-client_2main_8cpp_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">main.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *  Hello world example of a TLS client: fetch an HTTPS page</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *  Copyright (C) 2006-2015, ARM Limited, All Rights Reserved</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *  This file is part of mbed TLS (https://tls.mbed.org)</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *  This program is free software; you can redistribute it and/or modify</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> *  it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *  the Free Software Foundation; either version 2 of the License, or</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *  (at your option) any later version.</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *  This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> *  GNU General Public License for more details.</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> *  You should have received a copy of the GNU General Public License along</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> *  with this program; if not, write to the Free Software Foundation, Inc.,</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#if !defined(TARGET_LIKE_MBED)</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keywordtype">int</span> main() {</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    printf(<span class="stringliteral">&quot;this program only works on mbed OS\n&quot;</span>);</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;}</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">/* Change to a number between 1 and 4 to debug the TLS connection */</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#define DEBUG_LEVEL 0</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">/* Change to 1 to skip certificate verification (UNSAFE, for debug only!) */</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#define UNSAFE 0</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &quot;mbed.h&quot;</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &quot;EthernetInterface.h&quot;</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &quot;mbed-net-sockets/TCPStream.h&quot;</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#include &quot;test_env.h&quot;</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#include &quot;minar/minar.h&quot;</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">#include &quot;lwipv4_init.h&quot;</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="ssl_8h.html" title="SSL/TLS functions. ">mbedtls/ssl.h</a>&quot;</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="entropy_8h.html" title="Entropy accumulator implementation. ">mbedtls/entropy.h</a>&quot;</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="ctr__drbg_8h.html" title="CTR_DRBG based on AES-256 (NIST SP 800-90) ">mbedtls/ctr_drbg.h</a>&quot;</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="error_8h.html" title="Error to string translation. ">mbedtls/error.h</a>&quot;</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="preprocessor">#if DEBUG_LEVEL &gt; 0</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="debug_8h.html" title="Debug functions. ">mbedtls/debug.h</a>&quot;</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="keyword">namespace </span>{</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="keyword">const</span> <span class="keywordtype">char</span> *HTTPS_SERVER_NAME = <span class="stringliteral">&quot;developer.mbed.org&quot;</span>;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="keyword">const</span> <span class="keywordtype">int</span> HTTPS_SERVER_PORT = 443;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="keyword">const</span> <span class="keywordtype">int</span> RECV_BUFFER_SIZE = 600;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="keyword">const</span> <span class="keywordtype">char</span> HTTPS_PATH[] = <span class="stringliteral">&quot;/media/uploads/mbed_official/hello.txt&quot;</span>;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="keyword">const</span> <span class="keywordtype">size_t</span> HTTPS_PATH_LEN = <span class="keyword">sizeof</span>(HTTPS_PATH) - 1;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment">/* Test related data */</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="keyword">const</span> <span class="keywordtype">char</span> *HTTPS_OK_STR = <span class="stringliteral">&quot;200 OK&quot;</span>;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="keyword">const</span> <span class="keywordtype">char</span> *HTTPS_HELLO_STR = <span class="stringliteral">&quot;Hello world!&quot;</span>;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment">/* personalization string for the drbg */</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="keyword">const</span> <span class="keywordtype">char</span> *DRBG_PERS = <span class="stringliteral">&quot;mbed TLS helloword client&quot;</span>;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">/* List of trusted root CA certificates</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment"> * currently only GlobalSign, the CA for developer.mbed.org</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment"> * To add more than one root, just concatenate them.</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="keyword">const</span> <span class="keywordtype">char</span> SSL_CA_PEM[] =</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment">/* GlobalSign Root R1 SHA1/RSA/2048</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment"> *   Serial no.  04 00 00 00 00 01 15 4b 5a c3 94 */</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="stringliteral">&quot;-----BEGIN CERTIFICATE-----\n&quot;</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="stringliteral">&quot;MIIDdTCCAl2gAwIBAgILBAAAAAABFUtaw5QwDQYJKoZIhvcNAQEFBQAwVzELMAkG\n&quot;</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="stringliteral">&quot;A1UEBhMCQkUxGTAXBgNVBAoTEEdsb2JhbFNpZ24gbnYtc2ExEDAOBgNVBAsTB1Jv\n&quot;</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="stringliteral">&quot;b3QgQ0ExGzAZBgNVBAMTEkdsb2JhbFNpZ24gUm9vdCBDQTAeFw05ODA5MDExMjAw\n&quot;</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="stringliteral">&quot;MDBaFw0yODAxMjgxMjAwMDBaMFcxCzAJBgNVBAYTAkJFMRkwFwYDVQQKExBHbG9i\n&quot;</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="stringliteral">&quot;YWxTaWduIG52LXNhMRAwDgYDVQQLEwdSb290IENBMRswGQYDVQQDExJHbG9iYWxT\n&quot;</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="stringliteral">&quot;aWduIFJvb3QgQ0EwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDaDuaZ\n&quot;</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="stringliteral">&quot;jc6j40+Kfvvxi4Mla+pIH/EqsLmVEQS98GPR4mdmzxzdzxtIK+6NiY6arymAZavp\n&quot;</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="stringliteral">&quot;xy0Sy6scTHAHoT0KMM0VjU/43dSMUBUc71DuxC73/OlS8pF94G3VNTCOXkNz8kHp\n&quot;</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="stringliteral">&quot;1Wrjsok6Vjk4bwY8iGlbKk3Fp1S4bInMm/k8yuX9ifUSPJJ4ltbcdG6TRGHRjcdG\n&quot;</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="stringliteral">&quot;snUOhugZitVtbNV4FpWi6cgKOOvyJBNPc1STE4U6G7weNLWLBYy5d4ux2x8gkasJ\n&quot;</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="stringliteral">&quot;U26Qzns3dLlwR5EiUWMWea6xrkEmCMgZK9FGqkjWZCrXgzT/LCrBbBlDSgeF59N8\n&quot;</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="stringliteral">&quot;9iFo7+ryUp9/k5DPAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8E\n&quot;</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="stringliteral">&quot;BTADAQH/MB0GA1UdDgQWBBRge2YaRQ2XyolQL30EzTSo//z9SzANBgkqhkiG9w0B\n&quot;</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="stringliteral">&quot;AQUFAAOCAQEA1nPnfE920I2/7LqivjTFKDK1fPxsnCwrvQmeU79rXqoRSLblCKOz\n&quot;</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="stringliteral">&quot;yj1hTdNGCbM+w6DjY1Ub8rrvrTnhQ7k4o+YviiY776BQVvnGCv04zcQLcFGUl5gE\n&quot;</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="stringliteral">&quot;38NflNUVyRRBnMRddWQVDf9VMOyGj/8N7yy5Y0b2qvzfvGn9LhJIZJrglfCm7ymP\n&quot;</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="stringliteral">&quot;AbEVtQwdpf5pLGkkeB6zpxxxYu7KyJesF12KwvhHhm4qxFYxldBniYUr+WymXUad\n&quot;</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="stringliteral">&quot;DKqC5JlR3XC321Y9YeRq4VzW9v493kHMB65jUr9TU/Qr6cf9tveCX4XSQRjbgbME\n&quot;</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="stringliteral">&quot;HMUfpIBvFSDJ3gyICh3WZlXi/EjJKSZp4A==\n&quot;</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="stringliteral">&quot;-----END CERTIFICATE-----\n&quot;</span>;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;}</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="keyword">using namespace </span>mbed::Sockets::v0;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="keyword">class </span>HelloHTTPS {</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    HelloHTTPS(<span class="keyword">const</span> <span class="keywordtype">char</span> * domain, <span class="keyword">const</span> uint16_t port) :</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            _stream(SOCKET_STACK_LWIP_IPV4), _domain(domain), _port(port)</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    {</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        _error = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        _gothello = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        _got200 = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        _bpos = 0;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        _request_sent = 0;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        _stream.open(SOCKET_AF_INET4);</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <a class="code" href="entropy_8h.html#aa901e027093c6fe65dee5760db78aced" title="Initialize the context. ">mbedtls_entropy_init</a>(&amp;_entropy);</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        <a class="code" href="ctr__drbg_8h.html#a70dbec5e03601bf437ec488f2645743b" title="CTR_DRBG context initialization Makes the context ready for mbetls_ctr_drbg_seed() or mbedtls_ctr_drb...">mbedtls_ctr_drbg_init</a>(&amp;_ctr_drbg);</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        <a class="code" href="group__x509__module.html#ga016dd06bc770e77b84005f305df20ed1" title="Initialize a certificate (chain) ">mbedtls_x509_crt_init</a>(&amp;_cacert);</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <a class="code" href="ssl_8h.html#a8560dea66d7830a11874188727ec4c45" title="Initialize an SSL context Just makes the context ready for mbetls_ssl_setup() or mbedtls_ssl_free() ...">mbedtls_ssl_init</a>(&amp;_ssl);</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        <a class="code" href="ssl_8h.html#aba55bcda50a47e83803e31a8db7c9a86" title="Initialize an SSL configuration context Just makes the context ready for mbedtls_ssl_config_defaults(...">mbedtls_ssl_config_init</a>(&amp;_ssl_conf);</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    }</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    ~HelloHTTPS() {</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <a class="code" href="entropy_8h.html#a06778439f8a0e2daa2d3b444e06ad8dd" title="Free the data in the context. ">mbedtls_entropy_free</a>(&amp;_entropy);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <a class="code" href="ctr__drbg_8h.html#a1ea42b9eb6f6b33c82359f4c0a57ca43" title="Clear CTR_CRBG context data. ">mbedtls_ctr_drbg_free</a>(&amp;_ctr_drbg);</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        <a class="code" href="group__x509__module.html#gab33c1e4e20bea7ce536119f54a113c6b" title="Unallocate all certificate data. ">mbedtls_x509_crt_free</a>(&amp;_cacert);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <a class="code" href="ssl_8h.html#a2dc104a181bcd11eafbbf7e6923978bc" title="Free referenced items in an SSL context and clear memory. ">mbedtls_ssl_free</a>(&amp;_ssl);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <a class="code" href="ssl_8h.html#a7655f025440a6c5ccd4fc13832abb1dd" title="Free an SSL configuration context. ">mbedtls_ssl_config_free</a>(&amp;_ssl_conf);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    }</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="keywordtype">void</span> startTest(<span class="keyword">const</span> <span class="keywordtype">char</span> *path) {</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        <span class="comment">/* Initialize the flags */</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        _got200 = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        _gothello = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        _error = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        _disconnected = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        _request_sent = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <span class="comment">/* Fill the request buffer */</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        _bpos = snprintf(_buffer, <span class="keyword">sizeof</span>(_buffer) - 1, <span class="stringliteral">&quot;GET %s HTTP/1.1\nHost: %s\n\n&quot;</span>, path, HTTPS_SERVER_NAME);</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="comment">         * Initialize TLS-related stuf.</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <span class="keywordtype">int</span> ret;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="keywordflow">if</span> ((ret = <a class="code" href="ctr__drbg_8h.html#ad93d675f998550b4478c1fe6f4f34ebc" title="CTR_DRBG initial seeding Seed and setup entropy source for future reseeds. ">mbedtls_ctr_drbg_seed</a>(&amp;_ctr_drbg, <a class="code" href="entropy_8h.html#a81765f6cdf4e5111bcb9f4324f3234cb" title="Retrieve entropy from the accumulator (Maximum length: MBEDTLS_ENTROPY_BLOCK_SIZE) (Thread-safe if MB...">mbedtls_entropy_func</a>, &amp;_entropy,</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                          (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) DRBG_PERS,</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                          <span class="keyword">sizeof</span> (DRBG_PERS))) != 0) {</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            print_mbedtls_error(<span class="stringliteral">&quot;mbedtls_crt_drbg_init&quot;</span>, ret);</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;            _error = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        }</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        <span class="keywordflow">if</span> ((ret = <a class="code" href="group__x509__module.html#ga033567483649030f7f859db4f4cb7e14" title="Parse one or more certificates and add them to the chained list. Parses permissively. If some certificates can be parsed, the result is the number of failed certificates it encountered. If none complete correctly, the first error is returned. ">mbedtls_x509_crt_parse</a>(&amp;_cacert, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) SSL_CA_PEM,</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                           <span class="keyword">sizeof</span> (SSL_CA_PEM))) != 0) {</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;            print_mbedtls_error(<span class="stringliteral">&quot;mbedtls_x509_crt_parse&quot;</span>, ret);</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;            _error = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        }</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        <span class="keywordflow">if</span> ((ret = <a class="code" href="ssl_8h.html#aa1335b65ba57e81accc91ef95454d5a6" title="Load reasonnable default SSL configuration values. (You need to call mbedtls_ssl_config_init() first...">mbedtls_ssl_config_defaults</a>(&amp;_ssl_conf,</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                        MBEDTLS_SSL_IS_CLIENT,</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                        <a class="code" href="ssl_8h.html#acf690cf4772ff3e2df4b8295275e6fc7">MBEDTLS_SSL_TRANSPORT_STREAM</a>,</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                        MBEDTLS_SSL_PRESET_DEFAULT)) != 0) {</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;            print_mbedtls_error(<span class="stringliteral">&quot;mbedtls_ssl_config_defaults&quot;</span>, ret);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            _error = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        }</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        <a class="code" href="ssl_8h.html#a85c3bb6b682ba361d13de1c0a1eb69fb" title="Set the data required to verify peer certificate. ">mbedtls_ssl_conf_ca_chain</a>(&amp;_ssl_conf, &amp;_cacert, NULL);</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        <a class="code" href="ssl_8h.html#a469cd1c64bbba4be22347bf8874a017e" title="Set the random number generator callback. ">mbedtls_ssl_conf_rng</a>(&amp;_ssl_conf, <a class="code" href="ctr__drbg_8h.html#af6e4dd295ae790a33128562dd01c79ab" title="CTR_DRBG generate random. ">mbedtls_ctr_drbg_random</a>, &amp;_ctr_drbg);</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="preprocessor">#if UNSAFE</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="preprocessor"></span>        <a class="code" href="ssl_8h.html#a5695285c9dbfefec295012b566290f37" title="Set the certificate verification mode Default: NONE on server, REQUIRED on client. ">mbedtls_ssl_conf_authmode</a>(&amp;_ssl_conf, MBEDTLS_SSL_VERIFY_OPTIONAL);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="preprocessor">#if DEBUG_LEVEL &gt; 0</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="preprocessor"></span>        <a class="code" href="ssl_8h.html#afc2b6b55d7ccaf38d84a4fbf1655f426" title="Set the verification callback (Optional). ">mbedtls_ssl_conf_verify</a>(&amp;_ssl_conf, my_verify, NULL);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <a class="code" href="ssl_8h.html#ab15dcbe7c7fe2a5c118e7c486c07c921" title="Set the debug callback. ">mbedtls_ssl_conf_dbg</a>(&amp;_ssl_conf, my_debug, NULL);</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <a class="code" href="debug_8h.html#a6629362e96b43725ace95c8ff01d9985" title="Set the level threshold to handle globally. Messages that have a level over the threshold value are i...">mbedtls_debug_set_threshold</a>(DEBUG_LEVEL);</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        <span class="keywordflow">if</span> ((ret = <a class="code" href="ssl_8h.html#af79cb539a0ee6ac20cf9c574f4c3b343" title="Set up an SSL context for use. ">mbedtls_ssl_setup</a>(&amp;_ssl, &amp;_ssl_conf)) != 0) {</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;            print_mbedtls_error(<span class="stringliteral">&quot;mbedtls_ssl_setup&quot;</span>, ret);</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            _error = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        }</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <a class="code" href="ssl_8h.html#aa659024cf89e20d6d2248c0626db7ef2" title="Set hostname for ServerName TLS extension (client-side only) ">mbedtls_ssl_set_hostname</a>(&amp;_ssl, HTTPS_SERVER_NAME);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        <a class="code" href="ssl_8h.html#a143c1f887e1a2ca33b684ba4cf6c0543" title="Set the underlying BIO callbacks for write, read and read-with-timeout. ">mbedtls_ssl_set_bio</a>(&amp;_ssl, static_cast&lt;void *&gt;(&amp;_stream),</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                                   ssl_send, ssl_recv, NULL );</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        <span class="comment">/* Connect to the server */</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        printf(<span class="stringliteral">&quot;Starting DNS lookup for %s\r\n&quot;</span>, _domain);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        <span class="comment">/* Resolve the domain name: */</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        socket_error_t err = _stream.resolve(_domain, TCPStream::DNSHandler_t(<span class="keyword">this</span>, &amp;HelloHTTPS::onDNS));</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        _stream.error_check(err);</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    }</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="keywordtype">bool</span> done() {</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        <span class="keywordflow">return</span> _error || (_got200 &amp;&amp; _gothello);</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    }</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    <span class="keywordtype">bool</span> error() {</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        <span class="keywordflow">return</span> _error;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    }</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="keywordtype">void</span> close() {</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        _stream.close();</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        <span class="keywordflow">while</span> (!_disconnected)</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;            __WFI();</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    }</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="keyword">protected</span>:</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span> print_mbedtls_error(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">int</span> err) {</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        <span class="keywordtype">char</span> buf[128];</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <a class="code" href="error_8h.html#a8c41c149b77a4807115b19c2af858558" title="Translate a mbed TLS error code into a string representation, Result is truncated if necessary and al...">mbedtls_strerror</a>(err, buf, <span class="keyword">sizeof</span> (buf));</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        printf(<span class="stringliteral">&quot;%s() failed: -0x%04x (%d): %s\r\n&quot;</span>, name, -err, err, buf);</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    }</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="preprocessor">#if DEBUG_LEVEL &gt; 0</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span> my_debug(<span class="keywordtype">void</span> *ctx, <span class="keywordtype">int</span> level, <span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> line,</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                         <span class="keyword">const</span> <span class="keywordtype">char</span> *str)</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    {</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *basename;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        (void) ctx;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        <span class="comment">/* Extract basename from file */</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <span class="keywordflow">for</span>(p = basename = file; *p != <span class="charliteral">&#39;\0&#39;</span>; p++) {</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;            <span class="keywordflow">if</span>(*p == <span class="charliteral">&#39;/&#39;</span> || *p == <span class="charliteral">&#39;\\&#39;</span>) {</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                basename = p + 1;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;            }</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        }</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        printf(<span class="stringliteral">&quot;%s:%04d: |%d| %s&quot;</span>, basename, line, level, str);</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    }</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span> my_verify(<span class="keywordtype">void</span> *data, <a class="code" href="structmbedtls__x509__crt.html">mbedtls_x509_crt</a> *crt, <span class="keywordtype">int</span> depth, uint32_t *flags)</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    {</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        <span class="keywordtype">char</span> buf[1024];</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        (void) data;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        printf(<span class="stringliteral">&quot;\nVerifying certificate at depth %d:\n&quot;</span>, depth);</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        <a class="code" href="group__x509__module.html#gabaf30f2269fc3b6608b25871f9d09da6" title="Returns an informational string about the certificate. ">mbedtls_x509_crt_info</a>(buf, <span class="keyword">sizeof</span> (buf) - 1, <span class="stringliteral">&quot;  &quot;</span>, crt);</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        printf(<span class="stringliteral">&quot;%s&quot;</span>, buf);</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        <span class="keywordflow">if</span> (*flags == 0)</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;            printf(<span class="stringliteral">&quot;No verification issue for this certificate\n&quot;</span>);</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        {</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;            <a class="code" href="group__x509__module.html#gae88f1d8e6696eb2beeffe0a708219e6b" title="Returns an informational string about the verification status of a certificate. ">mbedtls_x509_crt_verify_info</a>(buf, <span class="keyword">sizeof</span> (buf), <span class="stringliteral">&quot;  ! &quot;</span>, *flags);</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;            printf(<span class="stringliteral">&quot;%s\n&quot;</span>, buf);</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        }</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    }</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span> ssl_recv(<span class="keywordtype">void</span> *ctx, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> len) {</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        TCPStream *stream = <span class="keyword">static_cast&lt;</span>TCPStream *<span class="keyword">&gt;</span>(ctx);</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        socket_error_t err = stream-&gt;recv(buf, &amp;len);</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        <span class="keywordflow">if</span> (err == SOCKET_ERROR_NONE) {</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(len);</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == SOCKET_ERROR_WOULD_BLOCK) {</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="ssl_8h.html#a67a1e093cf042831aa60bb567915b560">MBEDTLS_ERR_SSL_WANT_READ</a>;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        }</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    }</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span> ssl_send(<span class="keywordtype">void</span> *ctx, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> len) {</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        TCPStream *stream = <span class="keyword">static_cast&lt;</span>TCPStream *<span class="keyword">&gt;</span>(ctx);</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        socket_error_t err = stream-&gt;send(buf, len);</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        <span class="keywordflow">if</span> (err == SOCKET_ERROR_NONE) {</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(len);</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == SOCKET_ERROR_WOULD_BLOCK) {</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a>;</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;            <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        }</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    }</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="keywordtype">void</span> onError(Socket *s, socket_error_t err) {</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        (void) s;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        printf(<span class="stringliteral">&quot;MBED: Socket Error: %s (%d)\r\n&quot;</span>, socket_strerror(err), err);</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        _stream.close();</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        _error = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        MBED_HOSTTEST_RESULT(<span class="keyword">false</span>);</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    }</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keywordtype">void</span> onConnect(TCPStream *s) {</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        <span class="keywordtype">char</span> buf[16];</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        _remoteAddr.fmtIPv4(buf,<span class="keyword">sizeof</span>(buf));</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        printf(<span class="stringliteral">&quot;Connected to %s:%d\r\n&quot;</span>, buf, _port);</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        s-&gt;setOnReadable(TCPStream::ReadableHandler_t(<span class="keyword">this</span>, &amp;HelloHTTPS::onReceive));</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        s-&gt;setOnDisconnect(TCPStream::DisconnectHandler_t(<span class="keyword">this</span>, &amp;HelloHTTPS::onDisconnect));</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="comment">/* Start the handshake, the rest will be done in onReceive() */</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        printf(<span class="stringliteral">&quot;Starting the TLS handshake...\r\n&quot;</span>);</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        <span class="keywordtype">int</span> ret = <a class="code" href="ssl_8h.html#a4a37e497cd08c896870a42b1b618186e" title="Perform the SSL handshake. ">mbedtls_ssl_handshake</a>(&amp;_ssl);</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;            <span class="keywordflow">if</span> (ret != <a class="code" href="ssl_8h.html#a67a1e093cf042831aa60bb567915b560">MBEDTLS_ERR_SSL_WANT_READ</a> &amp;&amp;</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                ret != <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a>) {</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                print_mbedtls_error(<span class="stringliteral">&quot;mbedtls_ssl_handshake&quot;</span>, ret);</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                onError(s, SOCKET_ERROR_UNKNOWN);</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            }</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        }</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    }</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordtype">void</span> onReceive(Socket *s) {</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        <span class="comment">/* Send request if not done yet */</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        <span class="keywordflow">if</span> (!_request_sent) {</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            <span class="keywordtype">int</span> ret = <a class="code" href="ssl_8h.html#a5bbda87d484de82df730758b475f32e5" title="Write exactly &#39;len&#39; application data bytes. ">mbedtls_ssl_write</a>(&amp;_ssl, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) _buffer, _bpos);</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                <span class="keywordflow">if</span> (ret != <a class="code" href="ssl_8h.html#a67a1e093cf042831aa60bb567915b560">MBEDTLS_ERR_SSL_WANT_READ</a> &amp;&amp;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                    ret != <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a>) {</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                    print_mbedtls_error(<span class="stringliteral">&quot;mbedtls_ssl_write&quot;</span>, ret);</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                    onError(s, SOCKET_ERROR_UNKNOWN);</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                }</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            }</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;            <span class="comment">/* If we get here, the request was sent */</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;            _request_sent = 1;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;            <span class="comment">/* It also means the handshake is done, time to print info */</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;            printf(<span class="stringliteral">&quot;TLS connection to %s established\r\n&quot;</span>, HTTPS_SERVER_NAME);</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;            {</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                <span class="keywordtype">char</span> buf[1024];</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                <a class="code" href="group__x509__module.html#gabaf30f2269fc3b6608b25871f9d09da6" title="Returns an informational string about the certificate. ">mbedtls_x509_crt_info</a>(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;\r    &quot;</span>,</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                        <a class="code" href="ssl_8h.html#aa7ab0ac8d8341063a0f815ee99337831" title="Return the peer certificate from the current connection. ">mbedtls_ssl_get_peer_cert</a>(&amp;_ssl));</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                printf(<span class="stringliteral">&quot;Server certificate:\r\n%s\r&quot;</span>, buf);</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="preprocessor">#if defined(UNSAFE)</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="preprocessor"></span>                uint32_t flags = <a class="code" href="ssl_8h.html#a516064f1468d459159ef7cd6c496a026" title="Return the result of the certificate verification. ">mbedtls_ssl_get_verify_result</a>(&amp;_ssl);</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                <span class="keywordflow">if</span>( flags != 0 )</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;                {</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                    <a class="code" href="group__x509__module.html#gae88f1d8e6696eb2beeffe0a708219e6b" title="Returns an informational string about the verification status of a certificate. ">mbedtls_x509_crt_verify_info</a>(buf, <span class="keyword">sizeof</span> (buf), <span class="stringliteral">&quot;\r  ! &quot;</span>, flags);</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                    printf(<span class="stringliteral">&quot;Certificate verification failed:\r\n%s\r\r\n&quot;</span>, buf);</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                }</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="preprocessor"></span>                    printf(<span class="stringliteral">&quot;Certificate verification passed\r\n\r\n&quot;</span>);</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;            }</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        }</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="comment">/* Read data out of the socket */</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="keywordtype">int</span> ret = <a class="code" href="ssl_8h.html#aa2c29eeb1deaf5ad9f01a7515006ede5" title="Read at most &#39;len&#39; application data bytes. ">mbedtls_ssl_read</a>(&amp;_ssl, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) _buffer, <span class="keyword">sizeof</span>(_buffer));</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;            <span class="keywordflow">if</span> (ret != <a class="code" href="ssl_8h.html#a67a1e093cf042831aa60bb567915b560">MBEDTLS_ERR_SSL_WANT_READ</a> &amp;&amp; ret != <a class="code" href="ssl_8h.html#a674bde213fbbf602e04bbc131dd2dc33">MBEDTLS_ERR_SSL_WANT_WRITE</a>) {</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                print_mbedtls_error(<span class="stringliteral">&quot;mbedtls_ssl_read&quot;</span>, ret);</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                onError(s, SOCKET_ERROR_UNKNOWN);</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            }</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        }</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        _bpos = <span class="keyword">static_cast&lt;</span><span class="keywordtype">size_t</span><span class="keyword">&gt;</span>(ret);</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        _buffer[_bpos] = 0;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        <span class="comment">/* Check each of the flags */</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        _got200 = _got200 || strstr(_buffer, HTTPS_OK_STR) != NULL;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        _gothello = _gothello || strstr(_buffer, HTTPS_HELLO_STR) != NULL;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        <span class="comment">/* Print status messages */</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        printf(<span class="stringliteral">&quot;HTTPS: Received %d chars from server\r\n&quot;</span>, _bpos);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        printf(<span class="stringliteral">&quot;HTTPS: Received 200 OK status ... %s\r\n&quot;</span>, _got200 ? <span class="stringliteral">&quot;[OK]&quot;</span> : <span class="stringliteral">&quot;[FAIL]&quot;</span>);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        printf(<span class="stringliteral">&quot;HTTPS: Received &#39;%s&#39; status ... %s\r\n&quot;</span>, HTTPS_HELLO_STR, _gothello ? <span class="stringliteral">&quot;[OK]&quot;</span> : <span class="stringliteral">&quot;[FAIL]&quot;</span>);</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        printf(<span class="stringliteral">&quot;HTTPS: Received message:\r\n\r\n&quot;</span>);</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        printf(<span class="stringliteral">&quot;%s&quot;</span>, _buffer);</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        _error = !(_got200 &amp;&amp; _gothello);</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        s-&gt;close();</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    }</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    <span class="keywordtype">void</span> onDNS(Socket *s, <span class="keyword">struct</span> socket_addr addr, <span class="keyword">const</span> <span class="keywordtype">char</span> *domain) {</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        <span class="comment">/* Check that the result is a valid DNS response */</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        <span class="keywordflow">if</span> (socket_addr_is_any(&amp;addr)) {</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            <span class="comment">/* Could not find DNS entry */</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;            printf(<span class="stringliteral">&quot;Could not find DNS entry for %s&quot;</span>, HTTPS_SERVER_NAME);</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;            onError(s, SOCKET_ERROR_DNS_FAILED);</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            <span class="comment">/* Start connecting to the remote host */</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            <span class="keywordtype">char</span> buf[16];</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            _remoteAddr.setAddr(&amp;addr);</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;            _remoteAddr.fmtIPv4(buf,<span class="keyword">sizeof</span>(buf));</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;            printf(<span class="stringliteral">&quot;DNS Response Received:\r\n%s: %s\r\n&quot;</span>, domain, buf);</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;            printf(<span class="stringliteral">&quot;Connecting to %s:%d\r\n&quot;</span>, buf, _port);</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            socket_error_t err = _stream.connect(_remoteAddr, _port, TCPStream::ConnectHandler_t(<span class="keyword">this</span>, &amp;HelloHTTPS::onConnect));</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;            <span class="keywordflow">if</span> (err != SOCKET_ERROR_NONE) {</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                onError(s, err);</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;            }</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;        }</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    }</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="keywordtype">void</span> onDisconnect(TCPStream *s) {</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        s-&gt;close();</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        MBED_HOSTTEST_RESULT(!error());</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    }</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="keyword">protected</span>:</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    TCPStream _stream;              </div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *_domain;            </div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <span class="keyword">const</span> uint16_t _port;           </div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="keywordtype">char</span> _buffer[RECV_BUFFER_SIZE]; </div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="keywordtype">size_t</span> _bpos;                   </div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    SocketAddr _remoteAddr;         </div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="keyword">volatile</span> <span class="keywordtype">bool</span> _got200;          </div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <span class="keyword">volatile</span> <span class="keywordtype">bool</span> _gothello;        </div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="keyword">volatile</span> <span class="keywordtype">bool</span> _error;           </div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="keyword">volatile</span> <span class="keywordtype">bool</span> _disconnected;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="keyword">volatile</span> <span class="keywordtype">bool</span> _request_sent;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    <a class="code" href="structmbedtls__entropy__context.html" title="Entropy context structure. ">mbedtls_entropy_context</a> _entropy;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    <a class="code" href="structmbedtls__ctr__drbg__context.html" title="CTR_DRBG context structure. ">mbedtls_ctr_drbg_context</a> _ctr_drbg;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    <a class="code" href="structmbedtls__x509__crt.html">mbedtls_x509_crt</a> _cacert;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    <a class="code" href="structmbedtls__ssl__context.html">mbedtls_ssl_context</a> _ssl;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <a class="code" href="structmbedtls__ssl__config.html">mbedtls_ssl_config</a> _ssl_conf;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;};</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;EthernetInterface eth;</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;HelloHTTPS *hello;</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="keywordtype">void</span> app_start(<span class="keywordtype">int</span>, <span class="keywordtype">char</span>*[]) {</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="comment">/* The default 9600 bps is too slow to print full TLS debug info and could</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="comment">     * cause the other party to time out. Select a higher baud rate for</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="comment">     * printf(), regardless of debug level for the sake of uniformity. */</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    Serial pc(USBTX, USBRX);</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    pc.baud(115200);</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    MBED_HOSTTEST_TIMEOUT(120);</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    MBED_HOSTTEST_SELECT(<span class="keywordflow">default</span>);</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    MBED_HOSTTEST_DESCRIPTION(mbed TLS example HTTPS client);</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    MBED_HOSTTEST_START(<span class="stringliteral">&quot;MBEDTLS_EX_HTTPS_CLIENT&quot;</span>);</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    <span class="comment">/* Initialise with DHCP, connect, and start up the stack */</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    eth.init();</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    eth.connect();</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    lwipv4_socket_init();</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    hello = <span class="keyword">new</span> HelloHTTPS(HTTPS_SERVER_NAME, HTTPS_SERVER_PORT);</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    printf(<span class="stringliteral">&quot;Client IP Address is %s\r\n&quot;</span>, eth.getIPAddress());</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    mbed::FunctionPointer1&lt;void, const char*&gt; fp(hello, &amp;HelloHTTPS::startTest);</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    minar::Scheduler::postCallback(fp.bind(HTTPS_PATH));</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;}</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* TARGET_LIKE_MBED */</span><span class="preprocessor"></span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_19e0104c8f0ba8776372ed651dcf8954.html">yotta</a></li><li class="navelem"><a class="el" href="dir_b2f96014a242afa661b40f13fe4035b0.html">data</a></li><li class="navelem"><a class="el" href="dir_c35c14fd618bec4b2710f1374ae0ed07.html">example-tls-client</a></li><li class="navelem"><b>main.cpp</b></li>
    <li class="footer">Generated on Sun Aug 30 2015 15:29:51 for mbedtls by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
